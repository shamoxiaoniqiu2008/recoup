<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:his="http://centling.his.net/histag"
	xmlns:p="http://primefaces.org/ui">

<!-- 回车键，往下！引入的js文件 -->
<f:view contentType="text/html">
	<h:head>
		<title>#{pageConfig.sendDrugPaper}</title>


		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>

		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
	</h:head>

	<h:body>
		<p:growl id="messages"></p:growl>

		<h:form id="searchForm">
			<!-- 输入起始时间和截止时间 -->
			<table>
				<tr>
					<td class="leftcell">配药时间:</td>
					<td><p:calendar id="startDate" pattern="yyyy-MM-dd" size="9"
							value="#{sendDrugPaperController.startDate}" /></td>
					<td class="leftcell">至:</td>
					<td><p:calendar id="endDate" pattern="yyyy-MM-dd" size="9"
							value="#{sendDrugPaperController.endDate}" /></td>
					<td><p:commandLink
							actionListener="#{sendDrugPaperController.selectNextDay}"
							update=":searchForm,:listForm">
							<p:graphicImage value="/images/minus_alt.png"
								style="border:0px;width: 20px;height: 20px;" />
							<p:commandLink
								actionListener="#{sendDrugPaperController.selectLastDay}"
								update=":searchForm,:listForm">
								<p:graphicImage value="/images/plus_alt.png"
									style="border:0px;width: 20px;height: 20px;" />
							</p:commandLink>
						</p:commandLink></td>
					<td class="leftcell">是否提交:</td>
					<td><h:selectOneMenu
							value="#{sendDrugPaperController.sendFlag}" id="sendFlag"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
							<f:selectItem itemLabel="全部" />
							<f:selectItem itemLabel="已提交" itemValue="1" />
							<f:selectItem itemLabel="未提交" itemValue="2" />
						</h:selectOneMenu></td>
					<td class="leftcell"><p:commandButton id="searchButton"
							action="#{sendDrugPaperController.search}" styleClass="searchbtn"
							value="" update=":listForm,:showForm,:messages" /></td>
					<td class="leftcell"><p:commandButton
							action="#{sendDrugPaperController.clearSearchForm}"
							styleClass="commonbtn" value="清空" update=":searchForm,:messages" />
						<h:inputHidden value="checkSearchDate" id="checkSearchDate"
							validator="#{sendDrugPaperController.checkSearchDate}" /></td>
				</tr>
			</table>
		</h:form>
		<h:form id="listForm">
			<p:dataTable rows="10" style="white-space:nowrap;width:100%"
				id="listTable" value="#{sendDrugPaperController.dosages}"
				var="dosage" rowKey="#{dosage.id}" selectionMode="single"
				emptyMessage="没有相应记录" paginatorAlwaysVisible="false"
				selection="#{sendDrugPaperController.selectDosage}" paginator="true"
				paginatorPosition="bottom"
				paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
				<p:ajax event="rowSelect"
					listener="#{sendDrugPaperController.onDosageSelect}"
					update=":showForm,:messages" />
				<p:ajax event="rowUnselect"
					listener="#{sendDrugPaperController.onDosageUnselect}"
					update=":showForm,:messages" />
				<p:column headerText="配送分组" style="text-align:center;">
					<h:outputText value="#{dosage.deliveryname}" />
				</p:column>
				<p:column headerText="护理部" style="text-align:center;">
					<h:outputText value="#{dosage.nursedeptname}" />
				</p:column>
				<p:column headerText="负责人" style="text-align:center;">
					<h:outputText value="#{dosage.chartername}" />
				</p:column>
				<p:column headerText="是否提交" style="text-align:center;">
					<h:outputText value="是" rendered="#{dosage.issend == 1}" />
					<h:outputText value="否" rendered="#{dosage.issend == 2}" />
				</p:column>
				<p:column headerText="配药人" style="text-align:center;">
					<h:outputText value="#{dosage.senderName}" />
				</p:column>
				<p:column headerText="配药时间" style="text-align:center;">
					<h:outputText value="#{dosage.sendtime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="备注" style="text-align:center;">
					<h:outputText value="#{dosage.notes}" />
				</p:column>
			</p:dataTable>
			<div align="center">
				<p:commandButton value="新增" styleClass="commonbtn" ajax="true"
					process="@this" action="#{sendDrugPaperController.add}"
					oncomplete="addDig.show()"
					update=":showForm,:addForm,:showDetailForm,:infoForm,:messages" />
				<p:commandButton value="提交" styleClass="commonbtn" ajax="true"
					process="@this,listForm:checkSendData"
					oncomplete="onClickSend(xhr,status,args)" update=":messages" />
				<p:commandButton value="删除" styleClass="commonbtn" ajax="true"
					process="@this,listForm:checkModifyData"
					oncomplete="onClickDelete(xhr,status,args)"
					update=":listForm,:messages" />
				<h:inputHidden value="checkSendData" id="checkSendData"
					validator="#{sendDrugPaperController.checkSendData}" />
				<h:inputHidden value="checkModifyData" id="checkModifyData"
					validator="#{sendDrugPaperController.checkModifyData}" />
			</div>
		</h:form>
		<p:confirmDialog message="是否确认删除该发药单记录？" severity="alert"
			widgetVar="deleteConfirm" appendTo="@(body)">
			<h:form>
				<p:commandButton styleClass="submitbtn" value=""
					style="margin-left:80px;"
					actionListener="#{sendDrugPaperController.delete}"
					update=":listForm,:showForm,:messages" ajax="true"
					oncomplete="deleteConfirm.hide()" />
				<p:commandButton styleClass="cancelbtn" value=""
					onclick="deleteConfirm.hide()" type="button" />
			</h:form>
		</p:confirmDialog>
		<p:confirmDialog message="确认发放配药单消息？" severity="alert"
			widgetVar="sendConfirm" appendTo="@(body)">
			<h:form>
				<p:commandButton styleClass="submitbtn" value=""
					style="margin-left:80px;"
					actionListener="#{sendDrugPaperController.sendMessages}"
					update=":listForm,:messages,:showForm" ajax="true"
					oncomplete="sendConfirm.hide()" />
				<p:commandButton styleClass="cancelbtn" value=""
					onclick="sendConfirm.hide()" type="button" />
			</h:form>
		</p:confirmDialog>
		<h:form id="showForm">
			<p:dataTable rows="4" style="white-space:nowrap;width:100%"
				id="showTable" value="#{sendDrugPaperController.dosageDetails}"
				var="dosageDetail" rowKey="#{dosageDetail.id}" emptyMessage="没有相应记录"
				paginator="true" paginatorPosition="bottom"
				paginatorAlwaysVisible="false"
				paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
				<p:column headerText="老人姓名" style="text-align:center;">
					<h:outputText value="#{dosageDetail.olderName}" />
				</p:column>
				<p:column headerText="药品名称" style="text-align:center;">
					<h:outputText value="#{dosageDetail.drugName}" />
				</p:column>
				<p:column headerText="单次剂量" style="text-align:center;">
					<h:outputText value="#{dosageDetail.singleDose}" />
				</p:column>
				<p:column headerText="单位" style="text-align:center;">
					<h:outputText value="#{dosageDetail.unit}" />
				</p:column>
				<p:column headerText="服药日期" style="text-align:center;">
					<h:outputText value="#{dosageDetail.eattime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="时段" style="text-align:center;">
					<h:outputText value="早上" rendered="#{dosageDetail.period == 1}" />
					<h:outputText value="中午" rendered="#{dosageDetail.period == 2}" />
					<h:outputText value="晚上" rendered="#{dosageDetail.period == 3}" />
				</p:column>
				<p:column headerText="饭前/后" style="text-align:center;">
					<h:outputText value="饭前" rendered="#{dosageDetail.iseatfood == 1}" />
					<h:outputText value="饭后" rendered="#{dosageDetail.iseatfood == 2}" />
					<h:outputText value="均可"
						rendered="#{dosageDetail.iseatfood != 1 and dosageDetail.iseatfood != 2}" />
				</p:column>
				<p:column headerText="是否核对" style="text-align:center;">
					<h:outputText value="是" rendered="#{dosageDetail.ischeck == 1}" />
					<h:outputText value="否" rendered="#{dosageDetail.ischeck != 1}" />
				</p:column>
				<p:column headerText="核对结果" style="text-align:center;">
					<h:outputText value="通过"
						rendered="#{dosageDetail.checkresult == 1}" />
					<h:outputText value="未通过"
						rendered="#{dosageDetail.checkresult == 2}" />
					<h:outputText value=" "
						rendered="#{dosageDetail.checkresult != 1 and dosageDetail.checkresult != 2}" />
				</p:column>
				<p:column headerText="备注" style="text-align:center;">
					<h:outputText value="#{dosageDetail.notes}" />
				</p:column>
			</p:dataTable>
			<h:outputText value="&nbsp;"></h:outputText>
		</h:form>

		<p:dialog header="生成配药单确认" widgetVar="confirmDig" resizable="true"
			appendTo="@(body)" position="center" modal="true">
			<h:form id="confirmForm">
				<div style="font-size: 14px; font-weight: bolder; color: red;">
					以下药品生成配药单失败：</div>

				<p:dataTable rows="4" style="white-space:nowrap;width:100%"
					id="detailTable" value="#{sendDrugPaperController.drugFailList}"
					var="drugFail" rowKey="#{drugFail.id}" emptyMessage="没有相应记录"
					paginator="true" paginatorPosition="bottom"
					paginatorAlwaysVisible="false"
					paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
					<p:column headerText="老人姓名" style="text-align:center;">
						<h:outputText value="#{drugFail.olderName}" />
					</p:column>
					<p:column headerText="药品名称" style="text-align:center;">
						<h:outputText value="#{drugFail.drugreceiveName}" />
					</p:column>
					<p:column headerText="单次剂量" style="text-align:center;">
						<h:outputText value="#{drugFail.singleDose}" />
					</p:column>
					<p:column headerText="单位" style="text-align:center;">
						<h:outputText value="#{drugFail.unit}" />
					</p:column>
					<p:column headerText="饭前/后" style="text-align:center;">
						<h:outputText value="饭前"
							rendered="#{drugFail.beforeafterFlag == 1}" />
						<h:outputText value="饭后"
							rendered="#{drugFail.beforeafterFlag == 2}" />
						<h:outputText value="均可"
							rendered="#{drugFail.beforeafterFlag != 1 and drugFail.beforeafterFlag != 2}" />
					</p:column>
					<p:column headerText="备注" style="text-align:center;">
						<h:outputText value="#{drugFail.note}" />
					</p:column>
				</p:dataTable>
				<div align="center">
					<p:commandButton value="继续生成" styleClass="commonbtn"
						action="#{sendDrugPaperController.confirmCreateDetails}"
						oncomplete="confirmDig.hide()"
						update=":showDetailForm,:addForm,:messages"></p:commandButton>
					<p:commandButton value="取消" styleClass="commonbtn"
						onclick="confirmDig.hide()"></p:commandButton>
				</div>
			</h:form>

		</p:dialog>
		<p:dialog header="发药单信息" widgetVar="addDig" resizable="true"
			appendTo="@(body)" position="center" modal="true">
			<h:form id="addForm">
				<table style="width: 675px">
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputLabel
								value="配送分组:" for="olderName" style="text-align:right" /></td>
						<td class="hengbiaogedata"><h:inputHidden id="nurseDeptId"
								value="#{sendDrugPaperController.selectDosage.nursedeptid}" />
							<h:inputHidden id="nurseDeptNameHide"
								value="#{sendDrugPaperController.selectDosage.nursedeptname}" />
							<h:inputHidden id="chargerId"
								value="#{sendDrugPaperController.selectDosage.charterid}" /> <h:inputHidden
								id="chargerNameHide"
								value="#{sendDrugPaperController.selectDosage.chartername}" />
							<h:inputHidden id="deliveryId"
								value="#{sendDrugPaperController.selectDosage.deliveryId}" /> <p:inputText
								id="deliveryName"
								value="#{sendDrugPaperController.selectDosage.deliveryname}"
								required="true" requiredMessage="请选择配送类型！">
							</p:inputText> <his:IME for="addForm:deliveryName" rawSQL="true"
								SQL="#{sendDrugPaperController.addDeliverySQL}"
								fitcol="id,input_code"
								SQLResult="编号:0:hide,配送分组:1,护理部编号:2:hide,护理部:3,负责人编号:4:hide,负责人:5,输入码:6:hide"
								resultcol="1" lock="true"
								multiresult="addForm:deliveryId;0,addForm:deliveryName;1,addForm:nurseDeptId;2,addForm:nurseDeptNameHide;3,addForm:nurseDeptName;3,addForm:chargerId;4,addForm:chargerNameHide;5,addForm:chargerName;5" />
						</td>
						<td class="hengbiaogeHeader1 redfont"><h:outputLabel
								value="服药时间:" for="eatTime" style="text-align:right" /></td>
						<td class="hengbiaogedata"><p:calendar id="eatTime"
								pattern="yyyy-MM-dd" value="#{sendDrugPaperController.eatTime}"
								required="true" requiredMessage="请选择服药时间！" /></td>
						<td class="hengbiaogeHeader1 redfont"><h:outputLabel
								value="服药时段:" for="period" style="text-align:right" /></td>
						<td class="hengbiaogedata"><h:selectOneMenu
								style="width:126px" value="#{sendDrugPaperController.period}"
								id="period" required="true" requiredMessage="请选择服药时段！"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
								<f:selectItem itemLabel=" " />
								<f:selectItem itemLabel="早上" itemValue="1" />
								<f:selectItem itemLabel="中午" itemValue="2" />
								<f:selectItem itemLabel="晚上" itemValue="3" />
							</h:selectOneMenu></td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1"><h:outputLabel value="护理部:"
								for="nurseDeptName" style="text-align:right" /></td>
						<td class="hengbiaogedata"><p:inputText id="nurseDeptName"
								value="#{sendDrugPaperController.selectDosage.nursedeptname}"
								readonly="true">
							</p:inputText></td>
						<td class="hengbiaogeHeader1"><h:outputLabel value="负责人:"
								for="chargerName" style="text-align:right" /></td>
						<td class="hengbiaogedata"><p:inputText id="chargerName"
								value="#{sendDrugPaperController.selectDosage.chartername}"
								readonly="true">
							</p:inputText></td>
						<td class="hengbiaogedata" colspan="2" style="padding: 0 0 0 0"><p:commandButton
								value="生成" styleClass="commonbtn"
								action="#{sendDrugPaperController.createDetails}"
								oncomplete="noticeDiagShow(xhr, status, args)"
								update=":showDetailForm,:messages,:confirmForm" /> <p:commandButton
								value="未生成配药单查询" styleClass="commonbtn"
								action="#{sendDrugPaperController.searchFailDrugList}"
								oncomplete="FailDiagShow(xhr, status, args)"
								update=":failForm,:messages" /></td>
					</tr>
				</table>
			</h:form>
			<h:form id="showDetailForm">
				<p:dataTable rows="4" style="white-space:nowrap;width:100%"
					id="showDetailTable" paginatorAlwaysVisible="fasle"
					value="#{sendDrugPaperController.addDosageDetails}"
					var="dosageDetail" rowKey="#{dosageDetail.id}"
					emptyMessage="没有相应记录" paginator="true" paginatorPosition="bottom"
					paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
					<p:column headerText="老人姓名" style="text-align:center;">
						<h:outputText value="#{dosageDetail.olderName}" />
					</p:column>
					<p:column headerText="药品名称" style="text-align:center;">
						<h:outputText value="#{dosageDetail.drugName}" />
					</p:column>
					<p:column headerText="单次剂量" style="text-align:center;">
						<h:outputText value="#{dosageDetail.singleDose}" />
					</p:column>
					<p:column headerText="单位" style="text-align:center;">
						<h:outputText value="#{dosageDetail.unit}" />
					</p:column>
					<p:column headerText="饭前/后" style="text-align:center;">
						<h:outputText value="饭前" rendered="#{dosageDetail.iseatfood == 1}" />
						<h:outputText value="饭后" rendered="#{dosageDetail.iseatfood == 2}" />
						<h:outputText value="均可"
							rendered="#{dosageDetail.iseatfood != 1 and dosageDetail.iseatfood != 2}" />
					</p:column>
				</p:dataTable>
			</h:form>
			<h:form id="infoForm">
				<table style="width: 675px">
					<tr>
						<td class="hengbiaogeHeader1"><h:outputLabel value="备注:"
								for="notes" /></td>
						<td class="hengbiaogedata"><p:inputText id="notes"
								style="width:650px"
								value="#{sendDrugPaperController.selectDosage.notes}" /></td>
					</tr>
				</table>
				<div align="center">
					<p:commandButton value="提交" styleClass="commonbtn"
						action="#{sendDrugPaperController.saveAndSend}"
						oncomplete="afterSaveAndSend(xhr,status,args)"
						update=":listForm,:showForm,:messages"></p:commandButton>
					<p:commandButton value="保存" styleClass="commonbtn"
						action="#{sendDrugPaperController.saveDosage}"
						oncomplete="afterSaveDosage(xhr,status,args)"
						update=":listForm,:showForm,:messages"></p:commandButton>
					<p:commandButton value="关闭" styleClass="commonbtn"
						onclick="addDig.hide()" update=":messages"></p:commandButton>
				</div>
			</h:form>
		</p:dialog>

		<p:dialog header="未生成配药单药品" widgetVar="failDig" resizable="true"
			appendTo="@(body)" position="center" modal="true">
			<h:form id="failForm">
				<p:dataTable rows="4" style="white-space:nowrap;width:100%"
					id="detailTable" paginatorAlwaysVisible="false"
					value="#{sendDrugPaperController.unGenerateDosageDetails}"
					var="drugFail" rowKey="#{drugFail.id}" emptyMessage="没有相应记录"
					paginator="true" paginatorPosition="bottom"
					paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
					<p:column headerText="老人姓名" style="text-align:center;">
						<h:outputText value="#{drugFail.olderName}" />
					</p:column>
					<p:column headerText="药品名称" style="text-align:center;">
						<h:outputText value="#{drugFail.drugName}" />
					</p:column>
					<p:column headerText="单次剂量" style="text-align:center;">
						<h:outputText value="#{drugFail.singleDose}" />
					</p:column>
					<p:column headerText="单位" style="text-align:center;">
						<h:outputText value="#{drugFail.unit}" />
					</p:column>
					<p:column headerText="服药时间" style="text-align:center;">
						<h:outputText value="#{drugFail.eattime}">
							<f:convertDateTime pattern="yyyy-MM-dd"></f:convertDateTime>
						</h:outputText>
					</p:column>
					<p:column headerText="服药时段" style="text-align:center;">
						<h:outputText value="早上" rendered="#{drugFail.period == 1}" />
						<h:outputText value="中午" rendered="#{drugFail.period == 2}" />
						<h:outputText value="晚上" rendered="#{drugFail.period == 3}" />
					</p:column>
					<p:column headerText="饭前/后" style="text-align:center;">
						<h:outputText value="饭前" rendered="#{drugFail.iseatfood == 1}" />
						<h:outputText value="饭后" rendered="#{drugFail.iseatfood == 2}" />
						<h:outputText value="均可"
							rendered="#{drugFail.iseatfood != 1 and drugFail.iseatfood != 2}" />
					</p:column>
					<p:column headerText="备注" style="text-align:center;">
						<h:outputText value="#{drugFail.notes}" />
					</p:column>
				</p:dataTable>
				<div align="center">
					<p:commandButton value="关闭" styleClass="commonbtn"
						onclick="failDig.hide()"></p:commandButton>
				</div>
			</h:form>

		</p:dialog>
		<script type="text/javascript">
			function afterSaveAndSend(xhr, status, args) {
				if (args.validate) {
					addDig.hide();
				}
			}
			function afterSaveDosage(xhr, status, args) {
				if (args.validate) {
					addDig.hide();
				}
			}
			function onClickModify(xhr, status, args) {
				if (args.validate) {
					addDig.show();
				}
			}
			function onClickSend(xhr, status, args) {
				if (args.validate) {
					sendConfirm.show();
				}
			}
			function onClickDelete(xhr, status, args) {
				if (args.validate) {
					deleteConfirm.show();
				}
			}
			function afterAddDetail() {
				jQuery("#addForm\\:olderName").focus();
			}

			function noticeDiagShow(xhr, status, args) {
				if (args.notice) {
					confirmDig.show();
				}
			}

			function FailDiagShow(xhr, status, args) {
				if (args.show) {
					failDig.show();
				}
			}
		</script>
	</h:body>
</f:view>
</html>