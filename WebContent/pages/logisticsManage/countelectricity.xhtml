<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:his="http://centling.his.net/histag"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<f:view contentType="text/html">

	<style>
.ui-panel .ui-panel-content {
	padding: 0em !important;
}
</style>

	<h:head>
		<title>#{pageConfig.paidReport}</title>


		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>

		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/common.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
	</h:head>
	<script type="text/javascript">
		</script>

	<style>
.B1 {
	color: black
}

.B2 {
	color: red
}
</style>
	<h:body>
		<p:growl id="message" widgetVar="message"></p:growl>
		<p:growl id="messages"></p:growl>
		<h:form id="searchForm" style="display: inline">
			<h:outputText value="老人姓名:" style="text-align:right" />
			<h:inputHidden id="olderId"
				value="#{countElectricityController.olderId}"></h:inputHidden>
			<p:inputText id="olderName"
				value="#{countElectricityController.olderName}"></p:inputText>
			<his:IME for="searchForm:olderName" rawSQL="true"
				SQL="#{countElectricityController.olderSql}"
				fitcol="older_name,inputCode" multiresult="searchForm:olderId;0"
				SQLResult="编号:0,姓名:1" resultcol="1" lock="true" />
			<h:outputText value="起始时间:" style="text-align:right" />
			<p:calendar id="startDate" pattern="yyyy-MM-dd "
				value="#{countElectricityController.startDate}">
			</p:calendar>
			<h:outputText value="截止时间:" style="text-align:right" />
			<p:calendar id="endDate" pattern="yyyy-MM-dd"
				value="#{countElectricityController.endDate}">
			</p:calendar>
			<p:commandButton styleClass="searchbtn" value=""
				action="#{countElectricityController.search}"
				update=":reportForm,:messages"
				process="@this,startDate,endDate,olderId,olderName">
			</p:commandButton>
		</h:form>
		<h:form id="reportForm">
			<p:dataTable id="reports"
				value="#{countElectricityController.electricitys}" var="electricity"
				emptyMessage="没有记录" sortBy="olderName"
				rowStyleClass="#{electricity.electricityAmount > 0?'B1':'B2'}"
				rows="10" paginatorPosition="bottom"
				paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
				paginator="true" paginatorAlwaysVisible="false">
				<p:column id="olderName" style="width: 90px">
					<f:facet name="header">
						<h:outputText value="老人姓名"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.olderName}"></h:outputText>
				</p:column>
				<p:column id="roomName" style="width: 90px">
					<f:facet name="header">
						<h:outputText value="房间名称"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.roomName}"></h:outputText>
				</p:column>
				<p:column id="floorName" style="width: 90px">
					<f:facet name="header">
						<h:outputText value="楼层名称"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.floorName}"></h:outputText>
				</p:column>
				<p:column id="buildName" style="width: 90px">
					<f:facet name="header">
						<h:outputText value="大厦名称"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.buildName}"></h:outputText>
				</p:column>
				<p:column id="startTime" style="width: 120px">
					<f:facet name="header">
						<h:outputText value="开始时间"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.startTime}">
						<f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
					</h:outputText>
				</p:column>
				<p:column id="endTime" style="width: 120px">
					<f:facet name="header">
						<h:outputText value="结束时间"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.endTime}">
						<f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
					</h:outputText>
				</p:column>
				<p:column id="electricityAmount" style="width: 60px">
					<f:facet name="header">
						<h:outputText value="用电量"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.electricityAmount}">
						<f:convertNumber pattern="0.00" />
					</h:outputText>
				</p:column>
				<p:column id="unitPrice" style="width: 60px">
					<f:facet name="header">
						<h:outputText value="单价"></h:outputText>
					</f:facet>
					<h:outputText value="#{electricity.unitPrice}">
						<f:convertNumber pattern="0.00" />
					</h:outputText>
				</p:column>
				<p:column style="width: 60px" id="totalFee">
					<f:facet name="header">
						<h:outputText value="总额"></h:outputText>
					</f:facet>
					<h:outputText
						value="#{electricity.unitPrice * electricity.electricityAmount}">
						<f:convertNumber pattern="0.00" />
					</h:outputText>
				</p:column>
				<p:column id="chargeFlag" style="width: 60px">
					<f:facet name="header">
						<h:outputText value="是否录费"></h:outputText>
					</f:facet>
					<h:outputText value="是" rendered="#{electricity.chargeFlag == 1}" />
					<h:outputText value="否" rendered="#{electricity.chargeFlag == 2}" />
				</p:column>
				<p:summaryRow
					listener="#{countElectricityController.calculateTotalNum(electricity.olderId)}">
					<p:column colspan="6" style="text-align:right">
						<h:outputText value="总电量"></h:outputText>
					</p:column>
					<p:column>
						<h:outputText value="#{countElectricityController.total}"></h:outputText>
					</p:column>
					<p:column colspan="3">
					</p:column>
				</p:summaryRow>
			</p:dataTable>
			<div align="center"><p:commandButton styleClass="commonbtn"
				value="录入免费用电额度"
				action="#{countElectricityController.beforeAddFreeElectricity}"
				oncomplete="clickAddFree(xhr,status,args)"
				update=":freeForm,:messages"></p:commandButton>
				<p:commandButton styleClass="commonbtn" value="用电录费"
					action="#{countElectricityController.beforePayElectricity}"
					oncomplete="clickPayElectricity(xhr,status,args)"
					update=":payForm,:messages"></p:commandButton>
			</div>
		</h:form>
		<p:dialog widgetVar="payDig" appendTo="@(body)" resizable="true"
			header="电费录入" modal="true">
			<h:form id="payForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="老人姓名" /></td>
						<td class="hengbiaogedata"><p:inputText
							id="electricityOlderName"
							value="#{countElectricityController.payOlderName}">
							<p:ajax event="blur" process="@this,payForm:freeElectricity"
								listener="#{countElectricityController.showElectricityAmount}"
								update=":payForm,:messages,:ensureForm"></p:ajax>
						</p:inputText> <h:inputHidden id="freeElectricity"
							value="#{countElectricityController.payOlderId}"></h:inputHidden>
						<his:IME for="payForm:electricityOlderName" rawSQL="true"
							SQL="#{countElectricityController.freeOlderSql}"
							fitcol="older_name,inputCode" sortcol="older_id"
							multiresult="payForm:freeElectricity;0" SQLResult="编号:1,姓名:2"
							resultcol="1" lock="true" /></td>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="用电量" /></td>
						<td class="hengbiaogedata"><h:inputText id="shouldPayAmount"
							value="#{countElectricityController.shouldPayAmount}"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"></h:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="免费用电量" /></td>
						<td class="hengbiaogedata"><h:inputText id="freeAmount"
							value="#{countElectricityController.freeAmount}"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"></h:inputText>
						</td>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="应缴度数" /></td>
						<td class="hengbiaogedata"><h:inputText id="payAmount"
							value="#{countElectricityController.payAmount}"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"></h:inputText>
						</td>
					</tr>
				</table>
				<p:dataTable id="olderElectricitys"
					value="#{countElectricityController.olderElectricitys}"
					var="olderElectricity" emptyMessage="没有记录"
					rowStyleClass="#{olderElectricity.electricityAmount > 0?'B1':'B2'}"
					rows="6" paginatorAlwaysVisible="false" paginatorPosition="bottom"
					paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					paginator="true" >
					<p:column id="startTime">
						<f:facet name="header">
							<h:outputText value="开始时间"></h:outputText>
						</f:facet>
						<h:outputText value="#{olderElectricity.startTime}">
							<f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
						</h:outputText>
					</p:column>
					<p:column id="endTime">
						<f:facet name="header">
							<h:outputText value="结束时间"></h:outputText>
						</f:facet>
						<h:outputText value="#{olderElectricity.endTime}">
							<f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
						</h:outputText>
					</p:column>
					<p:column id="electricityAmount">
						<f:facet name="header">
							<h:outputText value="用电量"></h:outputText>
						</f:facet>
						<h:outputText value="#{olderElectricity.electricityAmount}">
							<f:convertNumber pattern="0.00" />
						</h:outputText>
					</p:column>
					<p:column id="unitPrice">
						<f:facet name="header">
							<h:outputText value="单价"></h:outputText>
						</f:facet>
						<h:outputText value="#{olderElectricity.unitPrice}">
							<f:convertNumber pattern="0.00" />
						</h:outputText>
					</p:column>
					<p:column id="totalFee">
						<f:facet name="header">
							<h:outputText value="总额"></h:outputText>
						</f:facet>
						<h:outputText
							value="#{olderElectricity.unitPrice * olderElectricity.electricityAmount}">
							<f:convertNumber pattern="0.00" />
						</h:outputText>
					</p:column>
				</p:dataTable>
				<div align="center"><p:commandButton styleClass="commonbtn"
					value="录费" action="#{countElectricityController.checkElectricityFee}"
					oncomplete="payElectricityFee(xhr,status,args)"
					update=":ensureForm,:messages"></p:commandButton> <p:commandButton
					styleClass="commonbtn" value="取消" onclick="payDig.hide()"></p:commandButton>
				</div>
			</h:form>
		</p:dialog>
		<p:dialog widgetVar="ensureConfirm" appendTo="@(body)"
			resizable="true" header="录费确认" modal="true">
			<h:form id="ensureForm">
				<div align="center">
				<h1 style="font-size: 18px; font-weight: bold">
				确认录入电费&nbsp;&nbsp; <font color="red"> <h:outputText
					value="#{countElectricityController.totalFee}" id="totalFee">
					<f:convertNumber pattern="0.00" />
				</h:outputText>&nbsp;&nbsp;</font> 元？</h1>
				</div>
				<p:commandButton styleClass="submitbtn" value="" ajax="true"
					process="@this" style="margin-left:80px;"
					actionListener="#{countElectricityController.payElectricity}"
					oncomplete="afterPayElectricityPurse(xhr,status,args)"
					update=":reportForm,:messages" />
				<p:commandButton styleClass="cancelbtn" value=""
					onclick="ensureConfirm.hide()" type="button" />
			</h:form>
		</p:dialog>
		<p:dialog widgetVar="freeLimitDig" appendTo="@(body)" resizable="true"
			header="录入免费额度" modal="true">
			<h:form id="freeForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="老人姓名" /></td>
						<td class="hengbiaogedata"><p:inputText id="freeOlderName"
							value="#{countElectricityController.freeElectricityName}">
							<p:ajax event="blur"
								process="@this,freeForm:freeOlderId,freeForm:freeOlderName"
								listener="#{countElectricityController.settleMaxFreeLimit}"
								update=":freeForm,:messages"></p:ajax>
						</p:inputText> <h:inputHidden id="freeOlderId"
							value="#{countElectricityController.freeElectricityId}"></h:inputHidden>
						<his:IME for="freeForm:freeOlderName" rawSQL="true"
							SQL="#{countElectricityController.freeOlderSql}"
							fitcol="older_name,inputCode" sortcol="older_id"
							multiresult="freeForm:freeOlderId;0" SQLResult="编号:1,姓名:2"
							resultcol="1" lock="true" /></td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="免费额度" /></td>
						<td class="hengbiaogedata"><h:inputText id="freeLimit"
							value="#{countElectricityController.freeLimit}" required="true"
							requiredMessage="请输入免费额度！"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"></h:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="开始时间" /></td>
						<td class="hengbiaogedata"><p:calendar id="freeStartDate"
							pattern="yyyy-MM-dd HH:mm" required="true" requiredMessage="请输入开始时间！"
							value="#{countElectricityController.freeStartDate}">
						</p:calendar></td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1 redfont"><h:outputText
							value="结束时间" /></td>
						<td class="hengbiaogedata"><p:calendar id="freeEndDate"
							pattern="yyyy-MM-dd HH:mm" required="true" requiredMessage="请输入结束时间！"
							value="#{countElectricityController.freeEndDate}">
						</p:calendar></td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1"><h:outputText value="开单人" /></td>
						<td class="hengbiaogedata"><h:inputText id="empName"
							value="#{countElectricityController.employee.name}"
							readonly="true"
							class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"></h:inputText>
						</td>
					</tr>
				</table>
				<div align="center"><p:commandButton styleClass="submitbtn"
					value="" action="#{countElectricityController.addFreeLimit}"
					oncomplete="afterAddFreeLimit(xhr,status,args)"
					process="@this,freeForm:freeOlderId,freeForm:freeLimit,freeForm:freeStartDate,freeForm:freeEndDate"
					update=":reportForm,:messages"></p:commandButton> <p:commandButton
					styleClass="closebtn" value="" onclick="freeLimitDig.hide()"
					type="button"></p:commandButton></div>
			</h:form>
		</p:dialog>
		<script type="text/javascript">
		function payElectricityFee(xhr,status,args){
			if (args.validate) {
				ensureConfirm.show()
			}
		}
		function afterPayElectricityPurse(xhr,status,args){
			if (args.validate) {
				payDig.hide();
			}
			ensureConfirm.hide();
		}
		function afterselectElectricityPurse(xhr,status,args) {
			if (args.validate) {
				ensureConfirm.show();
			}
		}
		function afterAddFreeLimit(xhr,status,args) {
			if (args.validate) {
				freeLimitDig.hide();
			}
		}
		function clickAddFree(xhr,status,args){
			if (args.validate) {
				freeLimitDig.show()
			}
		}
		function clickPayElectricity(xhr,status,args){
			if (args.validate) {
				payDig.show();
			}
		}
		function showTag(obj) {
			if(confirm("请务必完成该次电费录入，之后将没有权限！")){
		//		parent.showTag("financeManage/temppay.jsf?priceTypeId=3");
				parent.showTag("financeManage/temppay.jsf?priceTypeId=5&amp;olderId="+obj);
				jQuery("#payForm\\:hiddenBtn").click();

			}
		}
		</script>
	</h:body>
</f:view>
</html>
