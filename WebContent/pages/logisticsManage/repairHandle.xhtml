<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:his="http://centling.his.net/histag">

<!-- 回车键，往下！引入的js文件 -->
<f:view contentType="text/html">
	<h:head>
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/common.js?ver=#{projectConfig.ver}" />
	</h:head>
	<h:body>
		<p:growl id="messages"></p:growl>
		<h:form id="headForm">
			<h:panelGrid columns="15">
				<h:outputText value="&nbsp;&nbsp;提交时间:" style="width:80" />
				<p:calendar id="startDate" pattern="yyyy-MM-dd" size="15"
					value="#{repairHandleController.startDate}" />
				<h:outputText value="至:" style="width:80" />
				<p:calendar id="endDate" pattern="yyyy-MM-dd" size="15"
					value="#{repairHandleController.endDate}" />
				<!--<h:outputLabel value="老人姓名:" for="headForm:nameText" />
				<h:panelGroup>
					<p:inputText id="nameText" style="width:120px" />
					<his:IME for="headForm:nameText" fitcol="inputCode" resultcol="0"
						lock="true" rawSQL="true"
						SQL="#{entryVacationApplicationController.olderNameSql}"
						SQLResult="老人姓名:0,大厦:1,楼层:2,房间:3,床位:4,老人Id:5:hide,输入码:6"
						multiresult="headForm:olderIdHd;5" />
					<h:inputHidden id="olderIdHd"
						value="#{repairHandleController.olderId}" />
				</h:panelGroup>
				-->
				<h:outputLabel value="是否处理:" for="handleFlagText" />
				<h:selectOneMenu value="#{repairHandleController.handleFlag}"
					id="handleFlagText"
					class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
					<f:selectItem itemLabel="全部" itemValue="0" />
					<f:selectItem itemLabel="已处理" itemValue="1" />
					<f:selectItem itemLabel="未处理" itemValue="2" />
				</h:selectOneMenu>
				<p:commandButton id="searchButton"
					action="#{repairHandleController.selectRecords}"
					styleClass="searchbtn" value=""
					update=":dataTableForm:repairApplicationTable,:maintainForm,:messages" />
				<p:commandButton oncomplete="clearSelectForm()"
					styleClass="blankbtn" value=""
					action="#{repairHandleController.clearSelectForm}"
					update=":headForm,:messages" />
			</h:panelGrid>
		</h:form>
		<h:form id="dataTableForm">
			<h:panelGrid id="repairAppalicationRecord" style="width:100%">
				<p:dataTable cellspacing="8" rows="8" style="width:100%"
					id="repairApplicationTable" rowIndexVar="row"
					value="#{repairHandleController.records}" var="record"
					rowKey="#{record.id}" selectionMode="single" emptyMessage="没有相应记录"
					selection="#{repairHandleController.selectedRow}" paginator="true"
					paginatorPosition="bottom" paginatorAlwaysVisible="false"
					paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					dblClickSelect="true">
					<p:ajax event="rowSelect"
						listener="#{repairHandleController.selectRecord}"
						update=":dataTableForm,:maintainForm" />
					<p:ajax event="rowUnselect"
						listener="#{repairHandleController.unSelectRecord}"
						update=":dataTableForm,:maintainForm" />
					<p:ajax event="rowDblselect"
						listener="#{repairHandleController.clearSelectForm}"
						oncomplete="itemDialog.show()"
						update=":itemDataTableForm,:messages" />
					<p:column headerText="姓名" styleClass="width50">
						<h:outputText value="#{record.olderName}" />
					</p:column>
					<p:column headerText="大厦" styleClass="width50">
						<h:outputText value="#{record.buildName}" />
					</p:column>
					<p:column headerText="楼层" styleClass="width50">
						<h:outputText value="#{record.floorName}" />
					</p:column>
					<p:column headerText="房间" styleClass="width50">
						<h:outputText value="#{record.roomName}" />
					</p:column>
					<p:column headerText="维修类型" styleClass="width60">
						<h:outputText value="个人维修" rendered="#{record.repairType== 1}" />
						<h:outputText value="入住排查维修" rendered="#{record.repairType== 2}" />
						<h:outputText value="日常排查维修" rendered="#{record.repairType== 3}" />
					</p:column>
					<p:column headerText="维修描述" styleClass="width60">
						<h:outputText value="#{record.repairDetail}" />
					</p:column>
					<p:column headerText="提交时间" styleClass="width120">
						<h:outputText value="#{record.applyTime}">
							<f:convertDateTime pattern="yyyy-MM-dd HH:mm" timeZone="GMT+8" />
						</h:outputText>
					</p:column>
					<p:column headerText="已处理" styleClass="width50">
						<h:outputText value="是" rendered="#{record.handleFlag== 1}" />
						<h:outputText value="否" rendered="#{record.handleFlag!= 1}" />
					</p:column>
					<p:column headerText="处理人" styleClass="width50">
						<h:outputText value="#{record.repairerName}" />
					</p:column>
					<p:column headerText="处理时间" styleClass="width100">
						<h:outputText value="#{record.repairDate}">
							<f:convertDateTime pattern="yyyy-MM-dd HH:mm" timeZone="GMT+8" />
						</h:outputText>
					</p:column>
					<p:column headerText="已录费" styleClass="width50">
						<h:outputText value="是" rendered="#{record.payFlag==1}" />
						<h:outputText value="否" rendered="#{record.payFlag==2}" />
					</p:column>
					<p:column headerText="查看" styleClass="width50">
						<p:commandLink update=":itemDataTableForm,:messages"
							oncomplete="itemDialog.show()" title="查看"
							action="#{repairHandleController.selectDetails(record)}">
							<p:graphicImage value="/images/search.png" style="border:0px;" />
						</p:commandLink>
					</p:column>
				</p:dataTable>
			</h:panelGrid>
		</h:form>
		<h:form id="maintainForm">
			<div align="center">
				<p:commandButton styleClass="commonbtn" value="处理"
					disabled="#{repairHandleController.disHandleButton}"
					action="#{repairHandleController.copyRecordHandledRow}"
					oncomplete="handleHandleInit(xhr, status, args)"
					update=":handleForm,:detailListForm,:addDetailForm,:messages" />
				<p:commandButton styleClass="commonbtn" value="费用录入"
					action="#{repairHandleController.checkBeHandledAndPayed}"
					update=":messages" oncomplete="showTag(xhr, status, args)"
					disabled="#{repairHandleController.disPayButton}" />

			</div>
		</h:form>
		<p:dialog widgetVar="handleRecordDialog" header="处理" resizable="true"
			modal="true" focus=":addDetailForm:itemName">
			<h:form id="handleForm">
				<table width="795px">
					<tr>
						<td class="hengbiaogeHeader1" style="width: 67px"><h:outputLabel
								value="老人姓名:" for="nameText" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								id="nameText" readonly="true"
								value="#{repairHandleController.handledRow.olderName}" /></td>
						<td class="hengbiaogeHeader1" style="width: 41px"><h:outputLabel
								value="大厦:" for="buildingText" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								id="buildingText" readonly="true"
								value="#{repairHandleController.handledRow.buildName}" /></td>
						<td class="hengbiaogeHeader1" style="width: 41px"><h:outputLabel
								value="楼层:" for="floorText" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								id="floorText" readonly="true"
								value="#{repairHandleController.handledRow.floorName}" /></td>
						<td class="hengbiaogeHeader1" style="width: 41px"><h:outputLabel
								value="房间:" for="roomText" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								id="roomText" readonly="true"
								value="#{repairHandleController.handledRow.roomName}" /></td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1"><h:outputLabel value="维修明细:"
								for="detailText" /></td>
						<td colspan="9" class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px"><p:inputText
								id="detailText" style="width:717px" readonly="true"
								value="#{repairHandleController.handledRow.repairDetail}" /></td>

					</tr>
				</table>
			</h:form>
			<h:form id="addDetailForm">
				<table width="795px">
					<tr>
						<td class="hengbiaogeHeader1 redfont" style="width: 60px"><h:outputText
								value="材料名:" style="text-align:right" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								value="#{repairHandleController.insertedDetail.itemName}"
								id="itemName" required="true" requiredMessage="请填写项目名!" /> <his:IME
								for="addDetailForm:itemName" rawSQL="true"
								SQL="#{repairHandleController.goodsSql}" fitcol="itemId"
								SQLResult="编号:0:hide,名称:1,数量:2" resultcol="1" lock="true"
								multiresult="addDetailForm:itemId;0" /> <h:inputHidden
								value="#{repairHandleController.insertedDetail.itemId}"
								id="itemId" /></td>
						<td class="hengbiaogeHeader1 redfont" style="width: 41px"><h:outputText
								value="数量:" style="text-align:right" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								value="#{repairHandleController.materialAmount}" id="itemQty"
								required="true" requiredMessage="请填写数量!" /></td>
						<td class="hengbiaogeHeader1" style="width: 41px"><h:outputText
								value="备注:" style="text-align:right" /></td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 151px"><p:inputText
								value="#{repairHandleController.insertedDetail.note}" id="note" />
						</td>
						<td class="hengbiaogedata"
							style="padding: 0px 0px 0px 0px; width: 192px"><p:commandButton
								styleClass="commonbtn" style="height:20px" value="新增"
								action="#{repairHandleController.insertDetail}"
								oncomplete="afterAddDetail()"
								update=":handleForm,:detailListForm,:addDetailForm,:messages"></p:commandButton>
						</td>
					</tr>
				</table>
			</h:form>
			<h:form id="detailListForm">
				<p:dataTable id="detailList"
					value="#{repairHandleController.insertedDetails}"
					var="pensionGoodsDetail" rowKey="#{pensionGoodsDetail.id}"
					emptyMessage="当前无信息" paginator="true" rows="5"
					paginatorAlwaysVisible="false" paginatorPosition="bottom">
					<p:column headerText="项目名称">
						<h:outputText value="#{pensionGoodsDetail.itemName}" />
					</p:column>
					<p:column headerText="数量">
						<h:outputText value="#{pensionGoodsDetail.itemQty}">
							<f:convertNumber pattern="0.00" />
						</h:outputText>
					</p:column>
					<p:column headerText="备注">
						<h:outputText value="#{pensionGoodsDetail.note}" />
					</p:column>
					<p:column headerText="操作">
						<p:commandButton styleClass="deletebtn" value=""
							action="#{repairHandleController.deleteDetail(pensionGoodsDetail)}"
							update=":handleForm,:detailListForm,:messages" />
					</p:column>
				</p:dataTable>
			</h:form>
			<div style="width: 100%; text-align: center;">
				<p:commandButton styleClass="submitbtn" value=""
					action="#{repairHandleController.handleRecord}"
					oncomplete="handleHandleComplete(xhr, status, args)"
					update=":handleForm,:dataTableForm,:messages,:maintainForm" />
				<p:commandButton type="reset" styleClass="cancelbtn" value=""
					onclick="handleRecordDialog.hide()">
				</p:commandButton>
			</div>
		</p:dialog>
		<p:dialog header="材料明细" widgetVar="itemDialog" appendTo="@(body)"
			position="center" modal="true" width="300">
			<h:form id="itemDataTableForm">
				<h:panelGrid id="itemRecord" style="width:100%">
					<p:dataTable cellspacing="8" rows="10" style="width:100%"
						id="itemTable" rowIndexVar="row"
						value="#{repairHandleController.details}" var="record"
						rowKey="#{record.id}" emptyMessage="没有相应记录" paginator="true"
						paginatorPosition="bottom" paginatorAlwaysVisible="false"
						paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
						<p:column headerText="材料名">
							<h:outputText value="#{record.itemName}" />
						</p:column>
						<p:column headerText="数量">
							<h:outputText value="#{record.itemQty}" />
						</p:column>
					</p:dataTable>
				</h:panelGrid>
				<div style="width: 100%; text-align: center;">
					<p:commandButton type="reset" styleClass="closebtn" value=""
						onclick="itemDialog.hide()">
					</p:commandButton>
				</div>
			</h:form>
		</p:dialog>
		<p:confirmDialog modal="true" appendTo="@(body)" widgetVar="payDialog"
			message="您确认已缴费？确定后将不能再缴费！">
			<h:form>
				<p:commandButton styleClass="commonbtn" value="确定"
					action="#{repairHandleController.payRepairApplicationRecord}"
					update=":dataTableForm,:maintainForm,:messages"
					oncomplete="payDialog.hide();">
				</p:commandButton>
				<p:commandButton styleClass="commonbtn" value="取消" type="reset"
					onclick="payDialog.hide();"></p:commandButton>
			</h:form>
		</p:confirmDialog>
		<script type="text/javascript">
		//清空 selectForm
		function clearSelectForm(){
			document.getElementById("headForm:startDate").value="";
			document.getElementById("headForm:endDate").value="";
			return true;
		}
		function handleHandleInit(xhr, status, args){
			if(args.success) {
				handleRecordDialog.show();
            }	
		}
		function handleHandleComplete(xhr, status, args){
			if(!args.validationFailed &amp;&amp; args.success) {
				handleRecordDialog.hide();
            }	
		}
		function afterAddDetail(){
			jQuery("#addDetailForm\\:itemName").focus();
		}

		function showTag(xhr, status, args) {
			if(args.success) {	
				parent.showTag("financeManage/temppay.jsf?priceTypeId="+args.priceTypeId+"&amp;olderId="+args.olderId+"&amp;tableName="+args.tableName+"&amp;key="+args.pensionRepairId);
			}
		}
		function handlePayInit(xhr, status, args){
			if(args.success) {	
				payDialog.show();
			}
		}
		</script>
	</h:body>
</f:view>
</html>