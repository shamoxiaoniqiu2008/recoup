<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:his="http://centling.his.net/histag">

<!-- 回车键，往下！引入的js文件 -->
<f:view contentType="text/html">
	<h:head>
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css" ></link>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	    <script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/common.js?ver=#{projectConfig.ver}" />
	</h:head>
	<h:body>
		<p:growl id="messages" widgetVar="message"></p:growl>
		<h:form id="scheduleForm" styleClass="noDisable">
			<h:panelGrid columns="8" style="text-align:right;">
				<h:outputLabel value="&nbsp;&nbsp;车牌号:" />
				<h:panelGroup>
					<p:inputText id="carNumber" style="width:100px;" value="#{carOrderController.carNumber}">
						<p:ajax  event="blur" listener="#{carOrderController.onSelectedCar}"
						 oncomplete="PF('myschedule').update();handleUpdateComplete(xhr, status, args)"
						 process="@this,:scheduleForm">
						</p:ajax>
					</p:inputText>
					<his:IME for="scheduleForm:carNumber" fitcol="plate_number"
						resultcol="1" rawSQL="true"
						SQL="#{carOrderController.carSQL}"
						SQLResult="车辆Id:0:hide,车牌号:1,车辆类型:2,联系人:10,容纳人数:3"
						multiresult="scheduleForm:carId;0,scheduleForm:carType_hide;2,scheduleForm:carType;2,scheduleForm:driveName_hide;3,scheduleForm:driverName;3">
					</his:IME>
				</h:panelGroup>
				<h:outputLabel value="&nbsp;&nbsp;联系人:" />
				<h:panelGroup>
					<h:inputHidden id="carId" value="#{carOrderController.selectedCarId}"/>
					<h:inputHidden id="driveName_hide" value="#{carOrderController.driverName}"/>
					<h:inputHidden id="carType_hide" value="#{carOrderController.carType}"/>
					<p:inputText id="driverName" style="width:100px;" value="#{carOrderController.driverName}" readonly="true"/>
				</h:panelGroup>
				<h:outputLabel value="&nbsp;&nbsp;车辆类型:" />
				<h:panelGroup>
					<p:inputText id="carType" style="width:100px;" value="#{carOrderController.carType}" readonly="true"/>
				</h:panelGroup>
				<h:panelGroup>
					<p:commandButton styleClass="addbtn" value="" oncomplete="showAddDialog()"
						update=":addForm,:messages" action="#{carOrderController.invidCarNumber}">
					</p:commandButton>
				</h:panelGroup>
				<p:watermark value="请选择车辆" for="scheduleForm:carNumber"></p:watermark>
			</h:panelGrid>
			<div align="center">
			<p:schedule id="schedule" value="#{carOrderController.eventModel}" widgetVar="myschedule"
						slotMinutes="30" allDaySlot="false" firstHour="6" draggable="false" resizable="false"
						rightHeaderTemplate = "month, agendaWeek, agendaDay" style="height:100px" aspectRatio="3"
						view="month"  axisFormat="H:mm" minTime="#{carOrderController.currentDate}"
						timeFormat="yyyy-MM-dd HH:mm" 
						>  
		  
		        <p:ajax event="dateSelect" listener="#{carOrderController.onDateSelect}" update=":addForm,:messages" oncomplete="showAddDialog()" />  
		        <p:ajax event="eventSelect" listener="#{carOrderController.onEventSelect}" update=":updateForm" oncomplete="PF('updateDialog').show()" />  
<!-- 		        <p:ajax event="eventMove" listener="#{carOrderController.onEventMove}" update=":messages" />   -->
<!-- 		        <p:ajax event="eventResize" listener="#{carOrderController.onEventResize}" update=":messages" />   -->
		  
		    </p:schedule> 
		    </div> 
  		</h:form>
	    <p:dialog widgetVar="addDialog" header="添加预约" focus=":addForm:olderName" 
	    	showEffect="clip" hideEffect="clip" resizable="false" modal="true"
	    	position="300,50">  
 			<h:form id="addForm">
				<table class="hengbiaoge">
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="plateNumber">车牌号:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" requiredMessage="车牌号不能为空" id="plateNumber"  readonly="true"
								value="#{carOrderController.carNumber}">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="carType">车辆类型:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" requiredMessage="车辆类型不能为空" id="carType"  readonly="true"
								value="#{carOrderController.carType}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="olderName">老人姓名:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" id="olderName" requiredMessage="老人姓名不能为空" 
								value="#{carOrderController.addOrder.olderName}">
							</p:inputText>
							<his:IME for="addForm:olderName"
							fitcol="inputCode,oldName" resultcol="1" lock="true" rawSQL="true"
							SQL="#{departRegisterController.olderNameSql}"
							SQLResult="编号:6:hide,姓名:0,性别:5,大厦:1,楼层:2,房间:3,床位:4" 
							multiresult="addForm:olderIdHd;0" />
							<h:inputHidden id="olderIdHd" value="#{carOrderController.addOrder.olderId}" />
						</td>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="selectedCarId">联系人:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" id="selectedCarId" requiredMessage="联系人不能为空"   readonly="true"
								value="#{carOrderController.driverName}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectGotime_input">预计出发时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:calendar id="expectGotime" pattern="yyyy-MM-dd HH:mm" stepMinute="30"  required="true" size="20"
									    requiredMessage="预计出发时间不能为空" mindate="#{carOrderController.currentDate}"
									    value="#{carOrderController.addOrder.expectGotime}" />
						</td>
						<td class="hengbiaogeHeader1">
							<label >实际出发时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								readonly="true"
								value="#{carOrderController.addOrder.actualGotime}">
								<f:convertDateTime pattern="yyyy-MM-dd HH:mm"></f:convertDateTime>
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectBacktime_input">预计返回时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:calendar id="expectBacktime" pattern="yyyy-MM-dd HH:mm" stepMinute="30"  required="true" size="20"
									    requiredMessage="预计返回时间不能为空" mindate="#{carOrderController.currentDate}"
									    value="#{carOrderController.addOrder.expectBacktime}" />
						</td>
						<td class="hengbiaogeHeader1">
							<label >实际返回时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								readonly="true"
								value="#{carOrderController.addOrder.actualBacktime}">
								<f:convertDateTime pattern="yyyy-MM-dd HH:mm"></f:convertDateTime>
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectDistance">预计里程:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  type="number"
								required="true" id="expectDistance" requiredMessage="预计里程不能为空" 
								value="#{carOrderController.addOrder.expectDistance}">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<label>实际里程:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  type="number" id="actualDistance" readonly="true"
								value="#{carOrderController.addOrder.actualDistance}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label >是否登记:</label>
						</td>
						<td class="hengbiaogedata">
							<h:selectOneMenu disabled="true"
								style="width:150px"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"
								value="#{carOrderController.addOrder.registerFlag}">
								<f:selectItem itemValue="2" itemLabel="未登记" />
								<f:selectItem itemValue="1" itemLabel="已登记" />
							</h:selectOneMenu>						
						</td>
						<td class="hengbiaogeHeader1">
							<label >车辆状态:</label>
						</td>
						<td class="hengbiaogedata">
							<h:selectOneMenu disabled="true"
								style="width:150px"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"
								value="#{carOrderController.addOrder.vehicleState}">
								<f:selectItem itemValue="1" itemLabel="未出车" />
								<f:selectItem itemValue="2" itemLabel="已出车" />
								<f:selectItem itemValue="3" itemLabel="已返回" />
							</h:selectOneMenu>							
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<h:outputText for="matterDetail" value="详述:"/>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  id="matterDetail"
								value="#{carOrderController.addOrder.matterDetail}">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<h:outputText value="备注:"/>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  id="notes"
								value="#{carOrderController.addOrder.note}">
							</p:inputText>
						</td>
					</tr>
				</table>
				<h:panelGrid id="buttonGrid" columns="3" style="margin:0px auto">
					<p:commandButton 
						onstart="return checkNulls('addForm','redfont',true);"
						action="#{carOrderController.insertCarOrderRecord}"
						process="@this,addForm"  update=":messages"
						styleClass="submitbtn" value="" 
						oncomplete="PF('myschedule').update();afterAdd(xhr, status, args)"
						>
					</p:commandButton>
					<p:commandButton styleClass="blankbtn" value="" process="@this"
						actionListener="#{carOrderController.clearAddForm}"
						update=":addForm" />
					<p:commandButton onclick="addDialog.hide()" process="@this"
						styleClass="cancelbtn" value="" />
				</h:panelGrid>
			</h:form>
	    </p:dialog>  
	    <p:dialog widgetVar="updateDialog" header="预约信息" 
	    	showEffect="clip" hideEffect="clip" resizable="false" modal="true">  
 			<h:form id="updateForm">
				<table class="hengbiaoge">
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="plateNumber">车牌号:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" requiredMessage="车牌号不能为空" id="plateNumber"  
								readonly="true"
								value="#{carOrderController.carNumber}">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="carType">车辆类型:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" 
								requiredMessage="车辆类型不能为空" id="carType"  readonly="true"
								value="#{carOrderController.carType}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="olderName">老人姓名:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" id="olderName" requiredMessage="老人姓名不能为空" 
								readonly="#{carOrderController.selectedOrder.registerFlag == 1 } "
								value="#{carOrderController.selectedOrder.olderName}">
							</p:inputText>
							<his:IME for="updateForm:olderName"
							fitcol="inputCode,oldName" resultcol="1" lock="true" rawSQL="true"
							SQL="#{departRegisterController.olderNameSql}"
							SQLResult="编号:6:hide,姓名:0,性别:5,大厦:1,楼层:2,房间:3,床位:4" 
							multiresult="updateForm:olderIdHd;0" />
							<h:inputHidden id="olderIdHd" value="#{carOrderController.selectedOrder.olderId}" />
						</td>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="selectedCarId">联系人:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								required="true" id="selectedCarId" requiredMessage="联系人不能为空"   
								readonly="true"
								value="#{carOrderController.driverName}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectGotime">预计出发时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:calendar id="expectGotime" pattern="yyyy-MM-dd HH:mm" stepMinute="30" required="true" size="20"
									    requiredMessage="预计出发时间不能为空" mindate="#{carOrderController.currentDate}"
									    value="#{carOrderController.selectedOrder.expectGotime}" 
									    disabled="#{carOrderController.selectedOrder.registerFlag == 1 } "/>
						</td>
						<td class="hengbiaogeHeader1">
							<label >实际出发时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								readonly="true"
								value="#{carOrderController.selectedOrder.actualGotime}">
								<f:convertDateTime pattern="yyyy-MM-dd HH:mm"></f:convertDateTime>
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectBacktime">预计返回时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:calendar id="expectBacktime" pattern="yyyy-MM-dd HH:mm" stepMinute="30"  required="true" size="20"
									    requiredMessage="预计返回时间不能为空" mindate="#{carOrderController.currentDate}"
									    value="#{carOrderController.selectedOrder.expectBacktime}"
									    disabled="#{carOrderController.selectedOrder.registerFlag == 1 } " />
						</td>
						<td class="hengbiaogeHeader1">
							<label >实际返回时间:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText 
								readonly="true"
								value="#{carOrderController.selectedOrder.actualBacktime}">
								<f:convertDateTime pattern="yyyy-MM-dd HH:mm"></f:convertDateTime>
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label class="redfont" for="expectDistance">预计里程:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  type="number"
								required="true" id="expectDistance" requiredMessage="预计里程不能为空" 
								value="#{carOrderController.selectedOrder.expectDistance}"
								readonly="#{carOrderController.selectedOrder.registerFlag == 1 } ">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<label>实际里程:</label>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  type="number" id="actualDistance" readonly="true"
								value="#{carOrderController.selectedOrder.actualDistance}">
							</p:inputText>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<label >是否登记:</label>
						</td>
						<td class="hengbiaogedata">
							<h:selectOneMenu 
								style="width:150px" disabled="true"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"
								value="#{carOrderController.selectedOrder.registerFlag}">
								<f:selectItem itemValue="2" itemLabel="未登记" />
								<f:selectItem itemValue="1" itemLabel="已登记" />
							</h:selectOneMenu>
						</td>
						<td class="hengbiaogeHeader1">
							<label >车辆状态:</label>
						</td>
						<td class="hengbiaogedata">
							<h:selectOneMenu 
								style="width:150px" disabled="true"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"
								value="#{carOrderController.selectedOrder.vehicleState}">
								<f:selectItem itemValue="1" itemLabel="未出车" />
								<f:selectItem itemValue="2" itemLabel="已出车" />
								<f:selectItem itemValue="3" itemLabel="已返回" />
							</h:selectOneMenu>
						</td>
					</tr>
					<tr>
						<td class="hengbiaogeHeader1">
							<h:outputText  for="matterDetail" value="详述:"/>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  id="matterDetail"
								value="#{carOrderController.selectedOrder.matterDetail}">
							</p:inputText>
						</td>
						<td class="hengbiaogeHeader1">
							<h:outputText value="备注:"/>
						</td>
						<td class="hengbiaogedata">
							<p:inputText  id="notes"
								value="#{carOrderController.selectedOrder.note}">
							</p:inputText>
						</td>
					</tr>
				</table>
				<h:panelGrid id="buttonGrid" columns="3" style="margin:0px auto">
					<p:commandButton action="#{carOrderController.updateCarOrderRecord}"
						process="@this,updateForm,checkSelectDate" update=":updateForm,:messages"
						styleClass="modifybtn" value="" oncomplete="PF('myschedule').update();afterModify(xhr, status, args)"
						>
					</p:commandButton>
					<p:commandButton styleClass="deletebtn" value="" 
						ajax="true" process="@this,checkSelectDate"
						oncomplete="ckeckDeleteDate(xhr, status, args)"
						update=":updateForm,:messages"/>
					<p:commandButton onclick="updateDialog.hide()" process="@this"
						styleClass="cancelbtn" value="" />
					<h:inputHidden id="checkSelectDate" value="checkSelectDate" validator="#{carOrderController.checkSelectDate}"></h:inputHidden>
				</h:panelGrid>
			</h:form>
	    </p:dialog>  
		<!-- 删除记录的dialog -->
		<p:dialog appendTo="@(body)" modal="true" header="删除车辆预约记录"
			widgetVar="confirmDelDialog" width="220">
			<h:form id="confirmDelForm">
				<h:panelGrid>
					<f:facet name="header">
						<h:outputText value="#{pageConfig.sureDelete}?" style="font-weight:bold;" />
					</f:facet>
					<f:facet name="footer">
						<p:commandButton styleClass="submitbtn" value=""
							action="#{carOrderController.deleteCarOrderRecord}"
							oncomplete="PF('myschedule').update();afterDelete(xhr, status, args)">
						</p:commandButton>
						<p:commandButton styleClass="cancelbtn" value="" type="button"
							onclick="confirmDelDialog.hide();">
						</p:commandButton>
					</f:facet>
				</h:panelGrid>
			</h:form>
		</p:dialog>
		<script type="text/javascript">
			function handleUpdateComplete(xhr, status, args)
			{
				if(!args.validationFailed) 
				{
					addDialog.hide();
					updateDialog.hide();
					confirmDelDialog.hide();
			    }	
			          
			}
			function afterAdd(xhr, status, args){
				if (args.validate) {
					addDialog.hide();
				}
			}
			function afterModify(xhr, status, args){
				if (args.validate) {
					updateDialog.hide();
				}
			}
			function afterDelete(xhr, status, args){
				confirmDelDialog.hide();
				if (args.validate) {
					updateDialog.hide();
				}
			}
			function ckeckDeleteDate(xhr, status, args){
				if (args.validate) {
					confirmDelDialog.show();
				}
			}
			function showAddDialog()
			{
				var name = document.getElementById("scheduleForm:carNumber").value;
				if(name == "")
				{
					jQuery("#scheduleForm\\:carNumber").focus();
				}
				else
				{
					addDialog.show();
				}
				
			}
		</script>
	</h:body>
</f:view>
</html>