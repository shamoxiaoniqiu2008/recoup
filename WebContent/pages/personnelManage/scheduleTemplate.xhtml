<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:his="http://centling.his.net/histag"
	xmlns:p="http://primefaces.org/ui">
<f:view contentType="text/html">

<style>

.ui-panel .ui-panel-content {
	padding: 0em !important;
}
</style>

	<h:head>
		<title>#{pageConfig.scheduleTemplate}</title>


		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>

		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/common.js?ver=#{projectConfig.ver}" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
	</h:head>


	<h:body>
		<p:growl id="message" widgetVar="message"></p:growl>
		<p:growl id="messages"></p:growl>
		<h:form id="searchForm" style="display: inline">
		<h:outputText value="模板名称" />
			<h:inputHidden value="#{scheduleTemplateController.templateId}" id="templateId" />
			<p:inputText value="#{scheduleTemplateController.templateName}" id="templateName" >
			</p:inputText>
			<his:IME for="searchForm:templateName" fitcol="id,template_name"
				resultcol="1" lock="true" rawSQL="true"
				SQL="#{scheduleTemplateController.templateSql}"
				SQLResult="编号:0:hide,模板名称:1"
				multiresult="searchForm:templateId;0,searchForm:templateName;1" />
			<p:commandButton styleClass="searchbtn" value=""
				action="#{scheduleTemplateController.search}"
				update=":scheduleListForm,:messages">
			</p:commandButton>
		</h:form>

		<h:form id="scheduleListForm">
		<p:dataTable id="scheduleList" value="#{scheduleTemplateController.arrangeTemplateDetails}"
				var="detail" rowKey="#{detail.id}"
				emptyMessage="当前无内容" selectionMode="single"
				selection="#{scheduleTemplateController.selectTemplateDetail}" rows="10"
				paginatorAlwaysVisible="fasle" paginatorPosition="bottom"
				paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
				paginator="true">
				<p:ajax event="rowSelect"
					listener="#{scheduleTemplateController.onArrangeTemplateSelect}"
					update=":messages" />
				<p:ajax event="rowUnselect"
					listener="#{scheduleTemplateController.onArrangeTemplateUnselect}"
					update=":messages" />
				<p:column headerText="模板名称" style="text-align:center">
					<h:outputText value="#{detail.templateName}" />
				</p:column>
				<p:column headerText="部门名称" style="text-align:center">
					<h:outputText value="#{detail.departName}" />
				</p:column>
				<p:column headerText="员工姓名" style="text-align:center">
					<h:outputText value="#{detail.employeeName}" />
				</p:column>
				<p:column headerText="值班时段" style="text-align:center">
					<h:outputText value="#{detail.arrangeName}" />
				</p:column>
				<p:column headerText="开始时间" style="text-align:center">
					<h:outputText value="#{detail.startTime}">
						<f:convertDateTime pattern="HH:mm:ss" />
					</h:outputText>
				</p:column>
				<p:column headerText="结束时间" style="text-align:center">
					<h:outputText value="#{detail.endTime}">
						<f:convertDateTime pattern="HH:mm:ss" />
					</h:outputText>
				</p:column>
				<p:column headerText="备注" style="text-align:center">
					<h:outputText value="#{detail.note}">
					</h:outputText>
				</p:column>
			</p:dataTable>
			<div align="center">
				<p:commandButton value="创建模板" styleClass="commonbtn" ajax="true"
					process="@this" action="#{scheduleTemplateController.add}"
					oncomplete="modifyDig.show()"
					update=":modifyForm,:detailListForm,:messages">
				</p:commandButton>
				<p:commandButton value="修改模板" styleClass="commonbtn" ajax="true"
					process="@this,scheduleListForm:checkSelectData"
					action="#{scheduleTemplateController.modify}"
					oncomplete="afterCheckSelectData(xhr,status,args)"
					update=":modifyForm,:detailListForm,:messages">
				</p:commandButton>
				<p:commandButton value="删除" styleClass="commonbtn" ajax="true"
					process="@this,scheduleListForm:checkSelectData"
					oncomplete="afterCheckDeleteData(xhr,status,args)" update=":messages">
				</p:commandButton>
				<h:inputHidden id="checkSelectData" value="checkSelectData" validator="#{scheduleTemplateController.checkSelectData}"></h:inputHidden>
			</div>
		</h:form>
		
		<p:confirmDialog message="确认删除该模板的所有排班记录？" severity="alert"
			widgetVar="deleteConfirm" appendTo="@(body)">
			<h:form>
				<p:commandButton styleClass="submitbtn" value=""
					style="margin-left:80px;"
					actionListener="#{scheduleTemplateController.delete}"
					update=":scheduleListForm:scheduleList,:messages" ajax="true"
					oncomplete="deleteConfirm.hide()" />
				<p:commandButton styleClass="cancelbtn" value=""
					onclick="deleteConfirm.hide()" type="button" />
			</h:form>
			</p:confirmDialog>
			<p:dialog widgetVar="modifyDig" 
				appendTo="@(body)" resizable="true" header="人员值班模板" modal="true">
			<h:form id="modifyForm">
			<table>
				<tr>
					<td class="hengbiaogeHeader1" ><label class="redfont" for="dayAmount">模板名称</label></td>
					<td class="hengbiaogedata">
						<p:inputText value="#{scheduleTemplateController.template.templateName}" id="templateName" 
							disabled="#{scheduleTemplateController.addFlag}"
							required="true" requiredMessage="请填写模板名称！"/>
					</td>
					<td class="hengbiaogeHeader1"><label class="redfont" for="departName">部门名称</label></td>
					<td class="hengbiaogedata">
						<h:inputHidden value="#{scheduleTemplateController.template.deptId}" id="deptId" ></h:inputHidden>
						<p:inputText value="#{scheduleTemplateController.template.deptName}" id="deptName" 
							disabled="#{scheduleTemplateController.addFlag}"
							required="true" requiredMessage="请选择部门名称！">
							<p:ajax event="blur" process="@this,modifyForm:deptId,modifyForm:deptName"
								listener="#{scheduleTemplateController.onChangeSelectDeptId}"
								update=":modifyForm:addEmpPanel,:detailListForm,:messages"/>
						</p:inputText>
						<his:IME for="modifyForm:deptName" fitcol="id,inputCode"
							resultcol="1" lock="true" rawSQL="true"
							SQL="#{scheduleTemplateController.selectDeptSql}"
							SQLResult="编号:0:hide,部门名称:1,输入码:2:hide"
							multiresult="modifyForm:deptId;0,modifyForm:deptName;1" />
					</td>
					<td class="hengbiaogeHeader1" ><label class="redfont" for="employeeName">员工姓名</label></td>
					<td class="hengbiaogedata">
						<h:inputHidden value="#{scheduleTemplateController.selectTemplateDetail.employeeId}" id="employeeId" />
						<p:panel id="addEmpPanel" style="border: 0px;height: 29px;width: 150px;padding: 0px 0px 0px 0px">
							<p:inputText value="#{scheduleTemplateController.selectTemplateDetail.employeeName}" id="employeeName" 
								required="true" requiredMessage="请选择员工姓名！"/>
							<his:IME for="modifyForm:employeeName" fitcol="id,inputCode" 
								resultcol="1" lock="true" rawSQL="true"
								SQL="#{scheduleTemplateController.selectEmpSql}"
								SQLResult="编号:0:hide,姓名:1,输入码:2:hide"
								multiresult="modifyForm:employeeId;0,modifyForm:employeeName;1" />	
						</p:panel>
					</td>
					<td class="hengbiaogeHeader1"><label class="redfont" for="arrangeName">值班时段</label></td>
					<td class="hengbiaogedata"><h:inputHidden value="#{scheduleTemplateController.selectTemplateDetail.arrangeId}" id="arrangeId" />
						<h:inputHidden value="#{scheduleTemplateController.startTimeHidden}" id="startTimeHidden"></h:inputHidden>
						<h:inputHidden value="#{scheduleTemplateController.endTimeHidden}" id="endTimeHidden"></h:inputHidden>
						<p:inputText id="arrangeName"
							value="#{scheduleTemplateController.selectTemplateDetail.arrangeName}" 
							required="true" requiredMessage="请选择值班时段！" ></p:inputText>
						<his:IME for="modifyForm:arrangeName" fitcol="id,input_code"
							resultcol="1" lock="true" rawSQL="true"
							SQL="#{scheduleTemplateController.addArrageSql}"
							SQLResult="编号:0:hide,班次名称:1,输入码:2:hide,起始时间:3,结束时间:4,是否跨天:5"
							multiresult="modifyForm:arrangeId;0,modifyForm:arrangeName;1,modifyForm:startTime;3,modifyForm:endTime;4,modifyForm:startTimeHidden;3,modifyForm:endTimeHidden;4" /></td>
					<td class="hengbiaogedata"></td>
				</tr>
				<tr>
					<td class="hengbiaogeHeader1" ><label for="startTime">起始时间</label></td>
					<td class="hengbiaogedata">
						<p:inputText value="#{scheduleTemplateController.selectTemplateDetail.startTime}" id="startTime" readonly="true">
							<f:convertDateTime pattern="HH:mm:ss" />
						</p:inputText>
					</td>
					<td class="hengbiaogeHeader1" ><label for="endTime">结束时间</label></td>
					<td class="hengbiaogedata">
						<p:inputText value="#{scheduleTemplateController.selectTemplateDetail.endTime}" id="endTime" readonly="true">
							<f:convertDateTime pattern="HH:mm:ss" />
						</p:inputText>
					</td>
					<td class="hengbiaogeHeader1"><label for="note">备注</label></td>
					<td class="hengbiaogedata" colspan="3">
					<p:inputText id="note" style="width:365px" 
						value="#{scheduleTemplateController.selectTemplateDetail.note}"></p:inputText></td>
					<td class="hengbiaogedata">
						<p:commandLink
							action="#{scheduleTemplateController.addDetail}"
							update=":detailListForm,:modifyForm,:messages">
							<p:graphicImage value="/images/plus_alt.png" style="border:0px;;width: 20px;height: 20px;" />
						</p:commandLink>
					</td>	
				</tr>
			</table>
			</h:form>
			<h:form id="detailListForm">
					<p:dataTable id="detailList"
						value="#{scheduleTemplateController.details}"
						var="detail" rowKey="#{detail.id}"
						emptyMessage="当前无信息" paginator="true" rows="5"
						paginatorAlwaysVisible="false" paginatorPosition="bottom">
						<p:column headerText="名称">
							<h:outputText value="#{detail.employeeName}" />
						</p:column>
						<p:column headerText="时段名称">
							<h:outputText value="#{detail.arrangeName}" />
						</p:column>
						<p:column headerText="开始时间">
							<h:outputText value="#{detail.startTime}">
								<f:convertDateTime pattern="HH:mm:ss" />
							</h:outputText>
						</p:column>
						<p:column headerText="结束时间">
							<h:outputText value="#{detail.endTime}">
								<f:convertDateTime pattern="HH:mm:ss" />
							</h:outputText>
						</p:column>
						<p:column headerText="备注">
							<h:outputText value="#{detail.note}" />
						</p:column>
						<p:column headerText="操作">
							<p:commandLink process="@this" ajax="true" rendered="true"
								action="#{scheduleTemplateController.deleteDetail(detail)}"
								update=":detailListForm,:messages">
								<p:graphicImage value="/images/minus_alt.png" style="border:0px;width: 20px;height: 20px;" />
							</p:commandLink>
						</p:column>
					</p:dataTable>
			<div align="center">
			<p:commandButton value="保存" styleClass="commonbtn" 
				action="#{scheduleTemplateController.saveArrangeTemplate}"
				oncomplete="afterSaveArrangeTemplate(xhr,status,args)"
				update=":scheduleListForm,:modifyForm,:messages">
			</p:commandButton>
			<p:commandButton styleClass="closebtn" value="" type="button"
				onclick="modifyDig.hide()"></p:commandButton>
				</div>
			</h:form>
			</p:dialog>
			
		
		
	</h:body>
	<script type="text/javascript">
	
			function afterSaveArrangeTemplate(xhr,status,args){
				if (args.validate) {
					modifyDig.hide();
				}
			}
			function afterCheckSelectData(xhr,status,args){
				if (args.validate) {
					modifyDig.show();
				}
			}
			function afterCheckDeleteData(xhr,status,args){
				if (args.validate) {
					deleteConfirm.show();
				}
			} 
			function afterSaveAutoArranges(xhr,status,args){
				if (args.validate) {
					autoDig.hide();
				}
			}
		</script>
</f:view>

</html>