<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:his="http://centling.his.net/histag"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:ui="http://java.sun.com/jsf/facelets">
<f:view contentType="text/html">
	<h:head>
		<title>#{pageConfig.deposit}</title>


		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>

		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
	</h:head>
	<h:body>
		<p:growl id="messages"></p:growl>
		<h:form id="searchForm">
			<h:outputText value="&nbsp;&nbsp;老人姓名:" style="text-align:right" />
			<h:inputHidden value="#{depositController.depositId}" id="depositId" />
			<p:inputText value="#{depositController.olderName}" id="olderName" />
			<his:IME for="searchForm:olderName" rawSQL="true"
				SQL="#{depositController.selectSQL}" fitcol="id,inputCode"
				SQLResult="编号:0,输入码:1:hide,姓名:2,大厦:3,楼层:4,房间:5,床位:6" resultcol="2"
				lock="true" multiresult="searchForm:depositId;0" />
			<h:outputText value="老人状态:" style="text-align:right" />
			<h:selectOneMenu value="#{depositController.status}" id="status"
				class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
				<f:selectItem itemLabel="全部" />
				<f:selectItem itemValue="3" itemLabel="入住" />
				<f:selectItem itemValue="4" itemLabel="请假" />
				<f:selectItem itemValue="5" itemLabel="离院" />
				<f:selectItem itemValue="6" itemLabel="已结算" />
			</h:selectOneMenu>
			<h:outputText value="押金状态:" style="text-align:right" />
			<h:selectOneMenu value="#{depositController.depositStatus}"
				id="depositStatus"
				class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
				<f:selectItem itemLabel="全部" />
				<f:selectItem itemValue="1" itemLabel="未缴" />
				<f:selectItem itemValue="2" itemLabel="正常" />
			</h:selectOneMenu>
			<p:commandButton styleClass="searchbtn" value=""
				action="#{depositController.search}" update=":listForm,:messages">
			</p:commandButton>
			<p:commandButton styleClass="commonbtn" value="清空"
				onclick="clearSearchForm()" update=":searchForm,:messages"
				type="button">
			</p:commandButton>
		</h:form>

		<h:form id="listForm">
			<p:dataTable id="list" value="#{depositController.depositList}"
				var="deposit" rowKey="#{deposit.id}" emptyMessage="当前无内容"
				selectionMode="single"
				selection="#{depositController.selectDepoait}" rows="7"
				paginatorAlwaysVisible="false" paginatorPosition="bottom"
				paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
				paginator="true">
				<p:ajax event="rowSelect"
					listener="#{depositController.onDepositSelect}"
					update=":detailListForm,:messages" />
				<p:ajax event="rowUnselect"
					listener="#{depositController.onDepositUnselect}"
					update=":detailListForm,:messages" />
				<p:column headerText="老人姓名" style="text-align:center">
					<h:outputText value="#{deposit.olderName}" />
				</p:column>
				<p:column headerText="大厦名" style="text-align:center">
					<h:outputText value="#{deposit.buildingName}" />
				</p:column>
				<p:column headerText="楼层名" style="text-align:center">
					<h:outputText value="#{deposit.floorName}" />
				</p:column>
				<p:column headerText="房间名" style="text-align:center">
					<h:outputText value="#{deposit.roomName}" />
				</p:column>
				<p:column headerText="床位名" style="text-align:center">
					<h:outputText value="#{deposit.bedName}" />
				</p:column>
				<p:column headerText="押金额" style="text-align:center">
					<h:outputText value="#{deposit.deposit}" />
				</p:column>
				<p:column headerText="老人状态" style="text-align:center">
					<h:outputText value="#{deposit.statusName}">
					</h:outputText>
				</p:column>
			</p:dataTable>
			<div align="center">
				<p:commandButton value="缴纳押金" styleClass="commonbtn" ajax="true"
					process="@this,listForm:checkSelectData"
					action="#{depositController.beforePay}"
					oncomplete="checkPay(xhr,status,args)"
					update=":showForm,:chargeForm,:listForm,:payForm,:messages">
				</p:commandButton>
				<p:commandButton value="返还押金" styleClass="commonbtn" ajax="true"
					process="@this,listForm:checkSelectData"
					action="#{depositController.beforeBack}"
					oncomplete="checkBack(xhr,status,args)"
					update=":showBackForm,:listForm,:backForm,:backListForm,:messages">
				</p:commandButton>
				<h:inputHidden value="checkSelectData" id="checkSelectData"
					validator="#{depositController.checkSelectData}" />
			</div>
		</h:form>
		<h:form id="detailListForm">
			<p:dataTable id="detailList" value="#{depositController.depositLogs}"
				var="depositLog" rowKey="#{depositLog.id}" emptyMessage="当前无信息"
				paginator="true" rows="5" paginatorAlwaysVisible="false"
				paginatorPosition="bottom">
				<p:column headerText="押金类型">
					<h:outputText value="#{depositLog.depositTypeName}" />
				</p:column>
				<p:column headerText="交易额">
					<h:outputText value="#{depositLog.tradefee}" />
				</p:column>
				<p:column headerText="办理人">
					<h:outputText value="#{depositLog.traderName}" />
				</p:column>
				<p:column headerText="办理时间">
					<h:outputText value="#{depositLog.tradeDate}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="退费标记">
					<h:outputText value="已退" rendered="#{depositLog.backflag == 1}" />
				</p:column>
			</p:dataTable>
			<h:outputText value="&nbsp;"></h:outputText>
		</h:form>
		<p:dialog widgetVar="detailDig" modal="true" header="押金缴纳明细">
			<h:panelGrid columns="1">
				<h:panelGroup>
					<h:form id="payForm">
						<table>
							<tr>
								<td class="hengbiaogeHeader1 redfont"><h:outputText
										value="押金类型:" style="text-align:right" /></td>
								<td class="hengbiaogedata" width="120"
									style="padding: 0px 0px 0px 0px"><h:selectOneMenu
										style="width: 150px"
										value="#{depositController.selectDepositTypeId}"
										class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover"
										required="true" requiredMessage="请选择押金类型！" id="depositType">
										<f:selectItem itemLabel=" " />
										<f:selectItems value="#{depositController.depositTypes}"
											var="deposittype" rowKey="#{deposittype.id}"
											itemValue="#{deposittype.id}" itemLabel="#{deposittype.type}" />
										<p:ajax event="valueChange"
											process="@this,payForm:depositType"
											listener="#{depositController.selectTotalFees}"
											oncomplete="afterSelectTotalFees()"
											update=":showForm,:payForm,:messages"></p:ajax>
									</h:selectOneMenu></td>
								<td class="hengbiaogedata" colspan="2"></td>
							</tr>
							<tr>
								<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
										value="老人姓名:" style="text-align:right" /></td>
								<td class="hengbiaogedata" width="120"
									style="padding: 0px 0px 0px 0px"><p:inputText
										value="#{depositController.selectDepoait.olderName}" id="name"
										readonly="true" /></td>
								<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
										value="押金额:" style="text-align:right" /></td>
								<td class="hengbiaogedata" width="120"
									style="padding: 0px 0px 0px 0px"><p:inputText
										value="#{depositController.totalFees}" id="total"
										readonly="true" /></td>
							</tr>
							<ui:repeat id="payWays" value="#{depositController.payWays}"
								varStatus="varStatus" step="2">
								<tr>
									<td class="hengbiaogeHeader1" width="100"><h:outputText
											value="#{depositController.payWays[varStatus.index].paywayName}支付"
											style="text-align:right" /></td>
									<td class="hengbiaogedata" width="120"
										style="padding: 0px 0px 0px 0px"><p:inputText
											value="#{depositController.payWays[varStatus.index].payFee}"
											id="payWay#{varStatus.index}" styleClass="noDisable"
											rendered="#{fn:length(depositController.payWays)-1 ge (varStatus.index)}">
											<p:ajax event="keyup" process="@this,payWays"
												listener="#{depositController.calculateChange}"
												update=":showForm,:chargeForm,:messages"></p:ajax>
										</p:inputText></td>
									<td class="hengbiaogeHeader1" width="100"><h:outputText
											value="#{depositController.payWays[varStatus.index+1].paywayName}支付"
											style="text-align:right" /></td>
									<td class="hengbiaogedata" width="120"
										style="padding: 0px 0px 0px 0px"><p:inputText
											value="#{depositController.payWays[varStatus.index+1].payFee}"
											id="payWay#{varStatus.index+1}" styleClass="noDisable"
											rendered="#{(fn:length(depositController.payWays)-1) ge (varStatus.index+1)}">
											<p:ajax event="keyup" process="@this,payWays"
												listener="#{depositController.calculateChange}"
												update=":showForm,:chargeForm,:messages"></p:ajax>
										</p:inputText></td>
								</tr>
							</ui:repeat>
						</table>
					</h:form>
				</h:panelGroup>
				<h:panelGroup>
					<h:form id="chargeForm">
						<table>
							<tr>
								<td class="hengbiaogeHeader1" width="100"><h:outputText
										value="找零" style="text-align:right" /></td>
								<td class="hengbiaogedata" width="150"
									style="padding: 0px 0px 0px 0px"><h:selectOneMenu
										value="#{depositController.chargePayWay}"
										class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
										<f:selectItems value="#{depositController.payWays}"
											var="payWay" rowKey="#{payWay.id}" itemValue="#{payWay.id}"
											itemLabel="#{payWay.paywayName}">
										</f:selectItems>
										<p:ajax event="valueChange" process="@this"></p:ajax>
									</h:selectOneMenu> <p:inputText style="width: 75px"
										value="#{depositController.change}" readonly="true">
										<f:convertNumber pattern="0.00" />
									</p:inputText></td>
								<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
										value="" style="text-align:right" /></td>
								<td class="hengbiaogedata" width="150"
									style="padding: 0px 0px 0px 0px"><p:inputText value=""
										readonly="true" /></td>
							</tr>
						</table>
						<div align="center">
							<p:commandButton styleClass="submitbtn" value="" ajax="true"
								process="@this,chargeForm:checkPayData"
								action="#{depositController.pay}"
								oncomplete="afterPay(xhr,status,args)"
								update=":listForm,:detailListForm,:messages"></p:commandButton>
							<p:commandButton styleClass="closebtn" value=""
								onclick="detailDig.hide()" type="button"></p:commandButton>
							<h:inputHidden value="checkPayData" id="checkPayData"
								validator="#{depositController.checkPayData}" />
						</div>
					</h:form>
				</h:panelGroup>
			</h:panelGrid>
			<div align="center">
				<h:form id="showForm">
					<h1 style="font-size: 18px; font-weight: bold">
						<nobr> <font color="green">应收： <h:outputText
								value="#{depositController.totalFees}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="red">&nbsp;&nbsp;还差： <h:outputText
								value="#{depositController.left}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="blue">&nbsp;&nbsp;找零： <h:outputText
								value="#{depositController.change}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> </nobr>
					</h1>
				</h:form>
			</div>
		</p:dialog>
		<p:dialog widgetVar="backDig" modal="true" header="押金退费明细">
			<h:form id="backListForm">
				<p:dataTable id="detailList"
					value="#{depositController.backDepositLogs}" var="depositLog"
					rowKey="#{depositLog.id}"
					selection="#{depositController.selectDepositLog}"
					selectionMode="single" emptyMessage="当前无信息" paginator="true"
					rows="3" paginatorAlwaysVisible="false" paginatorPosition="bottom">
					<p:ajax event="rowSelect"
						listener="#{depositController.onSelectDepositLog}"
						update=":showBackForm,:backForm,:messages"
						oncomplete="afterSelectBackFees()" />
					<p:ajax event="rowUnselect"
						listener="#{depositController.onUnselectDepositLog}"
						update=":showBackForm,:backForm,:messages" />
					<p:column headerText="押金类型">
						<h:outputText value="#{depositLog.depositTypeName}" />
					</p:column>
					<p:column headerText="交易额">
						<h:outputText value="#{depositLog.tradefee}" />
					</p:column>
					<p:column headerText="办理人">
						<h:outputText value="#{depositLog.traderName}" />
					</p:column>
					<p:column headerText="办理时间">
						<h:outputText value="#{depositLog.tradeDate}">
							<f:convertDateTime pattern="yyyy-MM-dd" />
						</h:outputText>
					</p:column>
				</p:dataTable>
			</h:form>
			<h:form id="backForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="老人姓名:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{depositController.selectDepoait.olderName}" id="name"
								readonly="true" /></td>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="押金额:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{depositController.totalFees}" id="total"
								readonly="true" /></td>
					</tr>
					<ui:repeat id="payWays" value="#{depositController.payWays}"
						varStatus="varStatus" step="2">
						<tr>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{depositController.payWays[varStatus.index].paywayName}退款"
									style="text-align:right" /></td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{depositController.payWays[varStatus.index].payFee}"
									id="payWay#{varStatus.index}" styleClass="noDisable"
									rendered="#{(fn:length(depositController.payWays)-1) ge (varStatus.index)}">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{depositController.calculateChange}"
										update=":showBackForm,:messages"></p:ajax>
								</p:inputText></td>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{depositController.payWays[varStatus.index+1].paywayName}退款"
									style="text-align:right" /></td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{depositController.payWays[varStatus.index+1].payFee}"
									id="payWay#{varStatus.index+1}" styleClass="noDisable"
									rendered="#{(fn:length(depositController.payWays)-1) ge (varStatus.index+1)}">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{depositController.calculateChange}"
										update=":showBackForm,:messages"></p:ajax>
								</p:inputText></td>
						</tr>
					</ui:repeat>
				</table>
				<div align="center">
					<p:commandButton styleClass="submitbtn" value="" ajax="true"
						process="@this,backForm:checkPayData"
						action="#{depositController.pay}"
						oncomplete="afterBack(xhr,status,args)"
						update=":listForm,:detailListForm,:messages"></p:commandButton>
					<p:commandButton styleClass="closebtn" value=""
						onclick="backDig.hide()" type="button"></p:commandButton>
					<h:inputHidden value="checkPayData" id="checkPayData"
						validator="#{depositController.checkPayData}" />
				</div>
			</h:form>
			<div align="center">
				<h:form id="showBackForm">
					<h1 style="font-size: 18px; font-weight: bold">
						<nobr> <font color="green">应退： <h:outputText
								value="#{depositController.totalFees}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="red">&nbsp;&nbsp;还差： <h:outputText
								value="#{depositController.left}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="blue">&nbsp;&nbsp;多退： <h:outputText
								value="#{depositController.change}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> </nobr>
					</h1>
				</h:form>
			</div>
		</p:dialog>
		<script type="text/javascript">
			function afterSave() {
				addDig.hide();
			}
			function checkPay(xhr, status, args) {
				if (args.validate) {
					detailDig.show();
					jQuery("#payForm\\:depositType").focus();
				}
			}
			function checkBack(xhr, status, args) {
				if (args.validate) {
					backDig.show();
				}
			}
			function afterPay(xhr, status, args) {
				if (args.validate) {
					detailDig.hide();
				}
			}
			function afterBack(xhr, status, args) {
				if (args.validate) {
					backDig.hide();
				}
			}
			function clearSearchForm() {
				jQuery("#searchForm\\:olderName").val("");
				jQuery("#searchForm\\:status").val("");
				jQuery("#searchForm\\:depositStatus").val("");
			}
			function afterSelectTotalFees() {
				jQuery("#payForm\\:payWay0").focus();
			}
			function afterSelectBackFees() {
				jQuery("#backForm\\:payWay0").focus();
			}
		</script>
	</h:body>
</f:view>
</html>