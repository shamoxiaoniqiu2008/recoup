<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:his="http://centling.his.net/histag"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:ui="http://java.sun.com/jsf/facelets">
<f:view contentType="text/html">
	<h:head>
		<title>#{pageConfig.payTempPay}</title>


		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/default.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/skin.css" />
		<link type="text/css" rel="stylesheet"
			href="#{request.contextPath}/css/layout.css"></link>
		<link href="#{request.contextPath}/css/css.css" rel="stylesheet"
			type="text/css" />
		<link rel="stylesheet" href="#{request.contextPath}/css/style.css"></link>

		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/ime.js?ver=#{projectConfig.ver}" />
		<h:outputScript library="javax.faces" name="jsf.js" target="head" />
		<script type="text/javascript"
			src="#{request.contextPath}/resources/js/calendar.js?ver=#{projectConfig.ver}" />
	</h:head>
	<h:body>
		<p:growl id="messages"></p:growl>
		<h:form id="searchForm">
			<h:outputText value="&nbsp;&nbsp;老人姓名:" style="text-align:right" />
			<h:inputHidden value="#{payTempPayController.orderId}" id="orderId" />
			<p:inputText value="#{payTempPayController.orderName}" id="orderName" />
			<his:IME for="searchForm:orderName" rawSQL="true"
				SQL="#{payTempPayController.selectSQL}" fitcol="id,inputCode"
				SQLResult="编号:0,姓名:1,输入码:2:hide,性别:3,大厦:4,楼层:5,房间:6,床位:7"
				resultcol="1" lock="true"
				multiresult="searchForm:orderId;0,searchForm:orderName;1,searchForm:bedName;7" />
			<h:outputText value="床号:" style="text-align:right" />
			<p:inputText value="#{payTempPayController.orderBedName}"
				id="bedName" readonly="true" />
			<h:outputText value="已收费:" style="text-align:right" />
			<h:selectOneMenu value="#{payTempPayController.paidFlag}"
				id="paidFlag"
				class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
				<f:selectItem itemLabel="全部" />
				<f:selectItem itemValue="1" itemLabel="是" />
				<f:selectItem itemValue="2" itemLabel="否" />
			</h:selectOneMenu>
			<p:commandButton styleClass="searchbtn" value=""
				action="#{payTempPayController.search}"
				update=":payListForm,:messages">
			</p:commandButton>
			<p:commandButton styleClass="commonbtn" value="清空"
				onclick="clearSearchForm()" update=":searchForm,:messages">
			</p:commandButton>
		</h:form>

		<h:form id="payListForm">
			<p:dataTable id="list" value="#{payTempPayController.tempPayments}"
				var="tempPayment" rowKey="#{tempPayment.id}" emptyMessage="当前无内容"
				selectionMode="single"
				selection="#{payTempPayController.selectTempPayment}" rows="10"
				paginatorAlwaysVisible="false" paginatorPosition="bottom"
				paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
				paginator="true">
				<p:ajax event="rowSelect"
					listener="#{payTempPayController.onTempPaymentSelect}"
					update=":messages" />
				<p:ajax event="rowUnselect"
					listener="#{payTempPayController.onTempPaymentUnselect}"
					update=":messages" />
				<p:column headerText="老人姓名" style="text-align:center">
					<h:outputText value="#{tempPayment.name}" />
				</p:column>
				<p:column headerText="性别" style="text-align:center">
					<h:outputText value="#{tempPayment.sex}" />
				</p:column>
				<p:column headerText="总费用" style="text-align:center">
					<h:outputText value="#{tempPayment.totalfees}" />
				</p:column>
				<p:column headerText="开始时间" style="text-align:center">
					<h:outputText value="#{tempPayment.starttime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="结束时间" style="text-align:center">
					<h:outputText value="#{tempPayment.endtime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="录入员" style="text-align:center">
					<h:outputText value="#{tempPayment.generatorName}" />
				</p:column>
				<p:column headerText="录入日期" style="text-align:center">
					<h:outputText value="#{tempPayment.generatetime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="已收费" style="text-align:center">
					<h:outputText value="#{tempPayment.ispay eq 1 ?'是':'否'}" />
				</p:column>
				<p:column headerText="收费员" style="text-align:center">
					<h:outputText value="#{tempPayment.payeeName}" />
				</p:column>
				<p:column headerText="收费日期" style="text-align:center">
					<h:outputText value="#{tempPayment.paytime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
				<p:column headerText="已结算" style="text-align:center">
					<h:outputText value="#{tempPayment.isCloseStr}" />
				</p:column>
				<p:column headerText="结算员" style="text-align:center">
					<h:outputText value="#{tempPayment.closedName}" />
				</p:column>
				<p:column headerText="结算日期" style="text-align:center">
					<h:outputText value="#{tempPayment.closedtime}">
						<f:convertDateTime pattern="yyyy-MM-dd" />
					</h:outputText>
				</p:column>
			</p:dataTable>
			<div align="center">
				<p:commandButton value="缴费" styleClass="commonbtn" ajax="true"
					process="@this,payListForm:checkSelectData"
					action="#{payTempPayController.beforePay}"
					oncomplete="checkPay(xhr,status,args)"
					update=":chargeForm,:showForm,:listForm,:payForm,:backShowForm,:backListForm,:backPayForm,:messages">
				</p:commandButton>
				<h:inputHidden value="checkSelectData" id="checkSelectData"
					validator="#{payTempPayController.checkSelectData}" />
			</div>
		</h:form>
		<p:dialog widgetVar="detailDig" modal="true" header="临时缴费明细">
			<h:form id="listForm">
				<p:dataTable id="dailyPayList"
					value="#{payTempPayController.tempPaymentDetails}"
					var="tempPaymentDetail" rowKey="#{tempPaymentDetail.id}"
					emptyMessage="当前无信息" paginator="true" rows="5"
					paginatorAlwaysVisible="false" paginatorPosition="bottom">
					<p:column headerText="项目名称">
						<h:outputText value="#{tempPaymentDetail.itemName}" />
					</p:column>
					<p:column headerText="项目单价">
						<h:outputText value="#{tempPaymentDetail.itemlfees}" />
					</p:column>
					<p:column headerText="项目数量">
						<h:outputText value="#{tempPaymentDetail.number}" />
					</p:column>
					<p:column headerText="总额">
						<h:outputText value="#{tempPaymentDetail.totalfees}" />
					</p:column>
					<p:column headerText="退费类型">
						<h:outputText value="#{tempPaymentDetail.refundType}" />
					</p:column>
				</p:dataTable>
			</h:form>
			<h:form id="payForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="老人姓名:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{payTempPayController.olderName}" id="name"
								readonly="true" /></td>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="合计金额:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{payTempPayController.totalFees}" id="total"
								readonly="true" /></td>
					</tr>
					<ui:repeat id="payWays" value="#{payTempPayController.payWays}"
						varStatus="varStatus" step="2">
						<tr>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{payTempPayController.payWays[varStatus.index].paywayName}支付"
									rendered="#{fn:length(payTempPayController.payWays)-1 ge (varStatus.index)}"
									style="text-align:right" /></td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{payTempPayController.payWays[varStatus.index].payFee}"
									id="payWay#{varStatus.index}" styleClass="noDisable"
									rendered="#{fn:length(payTempPayController.payWays)-1 ge (varStatus.index)}"
									disabled="#{payTempPayController.payFlag}">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{payTempPayController.calculateChange}"
										update=":chargeForm,:showForm,:messages"></p:ajax>
								</p:inputText></td>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{payTempPayController.payWays[varStatus.index+1].paywayName}支付"
									style="text-align:right"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index+1)}" />
							</td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{payTempPayController.payWays[varStatus.index+1].payFee}"
									id="payWay#{varStatus.index+1}" styleClass="noDisable"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index+1)}"
									disabled="#{payTempPayController.payFlag}">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{payTempPayController.calculateChange}"
										update=":chargeForm,:showForm,:messages"></p:ajax>
								</p:inputText></td>
						</tr>
					</ui:repeat>
				</table>
			</h:form>
			<h:form id="chargeForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1" width="100"><h:outputText
								value="找零" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="150"
							style="padding: 0px 0px 0px 0px"><h:selectOneMenu
								value="#{payTempPayController.chargePayWay}"
								disabled="#{payTempPayController.payFlag}"
								class="ui-inputfield ui-widget ui-state-default ui-corner-all hasDatepicker ui-state-hover">
								<f:selectItems value="#{payTempPayController.payWays}"
									var="payWay" rowKey="#{payWay.id}" itemValue="#{payWay.id}"
									itemLabel="#{payWay.paywayName}">
								</f:selectItems>
								<p:ajax event="valueChange" process="@this"></p:ajax>
							</h:selectOneMenu> <p:inputText style="width: 75px"
								value="#{payTempPayController.change}" readonly="true">
								<f:convertNumber pattern="0.00" />
							</p:inputText></td>
						<td class="hengbiaogeHeader1" width="100"><h:outputText
								value="" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="150"
							style="padding: 0px 0px 0px 0px"></td>
					</tr>
				</table>
				<div align="center">
					<p:commandButton styleClass="submitbtn" value=""
						action="#{payTempPayController.pay}"
						disabled="#{payTempPayController.payFlag}"
						update="chargeForm,:payListForm,:payForm,:chargeForm,:messages"></p:commandButton>
					<p:commandButton styleClass="closebtn" value="" type="button"
						onclick="detailDig.hide()" update=":payListForm,:messages"></p:commandButton>
					<h:inputHidden value="checkPayData" id="checkPayData"
						validator="#{payTempPayController.checkPayData}" />
				</div>
			</h:form>
			<div align="center">
				<h:form id="showForm">
					<h1 style="font-size: 18px; font-weight: bold">
						<nobr> <font color="green">应收： <h:outputText
								value="#{payTempPayController.totalFees}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="red">&nbsp;&nbsp;还差： <h:outputText
								value="#{payTempPayController.left}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="blue">&nbsp;&nbsp;找零： <h:outputText
								value="#{payTempPayController.change}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> </nobr>
					</h1>
				</h:form>
			</div>
		</p:dialog>
		<p:dialog widgetVar="backDetailDig" header="临时项目退费" modal="true">
			<h:form id="backListForm">
				<p:dataTable id="backDailyPayList"
					value="#{payTempPayController.tempPaymentDetails}"
					var="tempPaymentDetail" rowKey="#{tempPaymentDetail.id}"
					emptyMessage="当前无信息" paginator="true" rows="5"
					paginatorAlwaysVisible="false" paginatorPosition="bottom">
					<p:column headerText="项目名称">
						<h:outputText value="#{tempPaymentDetail.itemName}" />
					</p:column>
					<p:column headerText="项目单价">
						<h:outputText value="#{tempPaymentDetail.itemlfees}" />
					</p:column>
					<p:column headerText="项目数量">
						<h:outputText value="#{tempPaymentDetail.number}" />
					</p:column>
					<p:column headerText="总额">
						<h:outputText value="#{tempPaymentDetail.totalfees}" />
					</p:column>
					<p:column headerText="退费类型">
						<h:outputText value="#{tempPaymentDetail.refundType}" />
					</p:column>
				</p:dataTable>
			</h:form>
			<h:form id="backPayForm">
				<table>
					<tr>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="老人姓名:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{payTempPayController.olderName}" id="name"
								readonly="true" /></td>
						<td class="hengbiaogeHeader1 redfont" width="100"><h:outputText
								value="合计金额:" style="text-align:right" /></td>
						<td class="hengbiaogedata" width="120"
							style="padding: 0px 0px 0px 0px"><p:inputText
								value="#{payTempPayController.totalFees}" id="total"
								readonly="true" /></td>
					</tr>
					<ui:repeat id="payWays" value="#{payTempPayController.payWays}"
						varStatus="varStatus" step="2">
						<tr>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{payTempPayController.payWays[varStatus.index].paywayName}退款"
									style="text-align:right"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index)}" />
							</td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{payTempPayController.payWays[varStatus.index].payFee}"
									id="payWay#{varStatus.index}" styleClass="noDisable"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index)}"
									disabled="#{payTempPayController.payFlag}">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{payTempPayController.calculateChange}"
										update=":backShowForm,:messages"></p:ajax>
								</p:inputText></td>
							<td class="hengbiaogeHeader1" width="100"><h:outputText
									value="#{payTempPayController.payWays[varStatus.index+1].paywayName}退款"
									style="text-align:right"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index+1)}" />
							</td>
							<td class="hengbiaogedata" width="120"
								style="padding: 0px 0px 0px 0px"><p:inputText
									value="#{payTempPayController.payWays[varStatus.index+1].payFee}"
									id="payWay#{varStatus.index+1}" styleClass="noDisable"
									rendered="#{(fn:length(payTempPayController.payWays)-1) ge (varStatus.index+1)}"
									disabled="#{payTempPayController.payFlag }">
									<p:ajax event="keyup" process="@this,payWays"
										listener="#{payTempPayController.calculateChange}"
										update=":backShowForm,:messages"></p:ajax>
								</p:inputText></td>
						</tr>
					</ui:repeat>
				</table>
				<div align="center">
					<p:commandButton styleClass="submitbtn" value="" ajax="true"
						process="@this,backPayForm:checkPayData"
						action="#{payTempPayController.pay}"
						disabled="#{payTempPayController.payFlag}"
						update=":payListForm,:backPayForm,:messages"></p:commandButton>
					<p:commandButton styleClass="closebtn" value="" type="button"
						onclick="backDetailDig.hide()" update=":payListForm,:messages"></p:commandButton>
				</div>
				<h:inputHidden value="checkPayData" id="checkPayData"
					validator="#{payTempPayController.checkPayData}" />
			</h:form>
			<div align="center">
				<h:form id="backShowForm">
					<h1 style="font-size: 18px; font-weight: bold">
						<nobr> <font color="green">应退： <h:outputText
								value="#{-payTempPayController.totalFees}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="red">&nbsp;&nbsp;还差： <h:outputText
								value="#{payTempPayController.left}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> <font color="blue">&nbsp;&nbsp;多退： <h:outputText
								value="#{payTempPayController.change}">
								<f:convertNumber pattern="0.00" />
							</h:outputText>
						</font> </nobr>
					</h1>
				</h:form>
			</div>
		</p:dialog>
		<script type="text/javascript">
			function afterSave() {
				addDig.hide();
			}
			function checkPay(xhr, status, args) {
				if (args.validate == "pay") {
					detailDig.show();
					jQuery("#payForm\\:cash").focus();
				}
				if (args.validate == "back") {
					backDetailDig.show();
					jQuery("#backPayForm\\:cash").focus();
				}
			}
			function clearSearchForm() {
				jQuery("#searchForm\\:orderName").val("");
				jQuery("#searchForm\\:bedName").val("");
				jQuery("#searchForm\\:paidFlag").val("");
			}
		</script>
	</h:body>
</f:view>
</html>